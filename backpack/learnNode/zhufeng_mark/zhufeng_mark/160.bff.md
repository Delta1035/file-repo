---
link: null
title: ç å³°æž¶æž„å¸ˆæˆé•¿è®¡åˆ’
description: null
keywords: null
author: null
date: null
publisher: ç å³°æž¶æž„å¸ˆæˆé•¿è®¡åˆ’
stats: paragraph=173 sentences=397, words=2737
---
## 1.è¯¾ç¨‹å¤§çº² [#](#t01è¯¾ç¨‹å¤§çº²)

* BFFæž¶æž„æ¼”è¿›
* RPCé«˜æ€§æ€§èƒ½BFFå®žæˆ˜
* DDDå’ŒGraphQLå®žæˆ˜BFF
* Serverlesså®žæˆ˜BFF

## 2.BFFæž¶æž„æ¼”è¿› [#](#t12bffæž¶æž„æ¼”è¿›)

![](https://static.zhufengpeixun.com/ge_ren_zhong_xin_1673108734927.png)

### 2.1 å•ä½“æœåŠ¡ [#](#t221-å•ä½“æœåŠ¡)

* å•ä½“æœåŠ¡æ˜¯æŒ‡ä¸€ä¸ªç‹¬ç«‹çš„åº”ç”¨ç¨‹åºï¼ŒåŒ…å«äº†æ‰€æœ‰çš„åŠŸèƒ½å’Œä¸šåŠ¡é€»è¾‘ã€‚è¿™ç§æž¶æž„æ–¹å¼åœ¨å°åž‹åº”ç”¨ç¨‹åºä¸­å¾ˆå¸¸è§
* éšç€åº”ç”¨ç¨‹åºçš„åŠŸèƒ½è¶Šæ¥è¶Šå¤šï¼Œä»£ç åº“ä¹Ÿä¼šè¶Šæ¥è¶Šå¤§ï¼Œç»´æŠ¤èµ·æ¥ä¹Ÿä¼šå˜å¾—æ›´åŠ å›°éš¾ã€‚æ­¤å¤–ï¼Œå•ä½“æœåŠ¡çš„æ•´ä½“å¤æ‚åº¦ä¹Ÿä¼šå¢žåŠ ï¼Œè¿™å¯èƒ½å¯¼è‡´è½¯ä»¶å¼€å‘å‘¨æœŸå˜é•¿ï¼Œè´¨é‡ä¸‹é™ï¼Œå¹¶ä¸”ç³»ç»Ÿçš„æ‰©å±•æ€§ä¹Ÿä¼šå—åˆ°é™åˆ¶

![](https://static.zhufengpeixun.com/web0_1673109441373.jpg)

### 2.2 å¾®æœåŠ¡ [#](#t322-å¾®æœåŠ¡)

* ä¸ºäº†åº”å¯¹è¿™äº›é—®é¢˜ï¼Œè®¸å¤šå…¬å¸å¼€å§‹ä½¿ç”¨å¾®æœåŠ¡æž¶æž„ã€‚å¾®æœåŠ¡æ˜¯æŒ‡å°†ä¸€ä¸ªå¤§åž‹åº”ç”¨ç¨‹åºæ‹†åˆ†æˆè‹¥å¹²ä¸ªå°åž‹æœåŠ¡ï¼Œæ¯ä¸ªæœåŠ¡è´Ÿè´£æ‰§è¡Œç‰¹å®šçš„ä»»åŠ¡ã€‚è¿™ç§æž¶æž„æ–¹å¼å¯ä»¥å¸®åŠ©å…¬å¸æ›´å¿«åœ°å¼€å‘å’Œéƒ¨ç½²æ–°åŠŸèƒ½ï¼Œå¹¶æé«˜ç³»ç»Ÿçš„å¯æ‰©å±•æ€§å’Œå¯ç»´æŠ¤æ€§
* è¿™ç§æ–¹å¼ä¼šæœ‰ä»¥ä¸‹é—®é¢˜
  - åŸŸåå¼€é”€å¢žåŠ 
    + å†…éƒ¨æœåŠ¡å™¨æš´éœ²åœ¨å…¬ç½‘ï¼Œæœ‰å®‰å…¨éšæ‚£
    + å„ä¸ªç«¯æœ‰å¤§é‡çš„ä¸ªæ€§åŒ–éœ€æ±‚
      * æ•°æ®èšåˆ æŸäº›åŠŸèƒ½å¯èƒ½éœ€è¦è°ƒç”¨å¤šä¸ªå¾®æœåŠ¡è¿›è¡Œç»„åˆ
        - æ•°æ®è£å‰ª åŽç«¯æœåŠ¡è¿”å›žçš„æ•°æ®å¯èƒ½éœ€è¦è¿‡æ»¤æŽ‰ä¸€äº›æ•æ„Ÿæ•°æ®
        - æ•°æ®é€‚é… åŽç«¯è¿”å›žçš„æ•°æ®å¯èƒ½éœ€è¦é’ˆå¯¹ä¸åŒç«¯è¿›è¡Œæ•°æ®ç»“æž„çš„é€‚é…ï¼ŒåŽç«¯è¿”å›ž `XML`ï¼Œä½†å‰ç«¯éœ€è¦ `JSON`
        - æ•°æ®é‰´æƒ ä¸åŒçš„å®¢æˆ·ç«¯æœ‰ä¸åŒçš„æƒé™è¦æ±‚

![](https://static.zhufengpeixun.com/web15_1673110992237.jpg)

### 2.3 BFF [#](#t423-bff)

* BFFæ˜¯ `Backend for Frontend`çš„ç¼©å†™ï¼ŒæŒ‡çš„æ˜¯ä¸“é—¨ä¸ºå‰ç«¯åº”ç”¨è®¾è®¡çš„åŽç«¯æœåŠ¡
* ä¸»è¦ç”¨æ¥ä¸ºå„ä¸ªç«¯æä¾›ä»£ç†æ•°æ®èšåˆã€è£å‰ªã€é€‚é…å’Œé‰´æƒæœåŠ¡ï¼Œæ–¹ä¾¿å„ä¸ªç«¯æŽ¥å…¥åŽç«¯æœåŠ¡
* BFFå¯ä»¥æŠŠå‰ç«¯å’Œå¾®æœåŠ¡è¿›è¡Œè§£è€¦ï¼Œå„è‡ªå¯ä»¥ç‹¬ç«‹æ¼”è¿›

![](https://static.zhufengpeixun.com/web23_1673111569390.jpg)

### 2.4 ç½‘å…³ [#](#t524-ç½‘å…³)

* API ç½‘å…³æ˜¯ä¸€ç§ç”¨äºŽåœ¨åº”ç”¨ç¨‹åºå’Œ API ä¹‹é—´æä¾›å®‰å…¨è®¿é—®çš„ä¸­é—´å±‚
* API ç½‘å…³è¿˜å¯ä»¥ç”¨äºŽç›‘æŽ§ API è°ƒç”¨ï¼Œè·¯ç”±è¯·æ±‚ï¼Œä»¥åŠåœ¨è¯·æ±‚å’Œå“åº”ä¹‹é—´æ·»åŠ é™„åŠ åŠŸèƒ½ï¼ˆä¾‹å¦‚èº«ä»½éªŒè¯ï¼Œç¼“å­˜ï¼Œæ•°æ®è½¬æ¢ï¼ŒåŽ‹ç¼©ã€æµé‡æŽ§åˆ¶ã€é™æµç†”æ–­ã€é˜²çˆ¬è™«ç­‰ï¼‰
* ç½‘å…³å’ŒBFFå¯èƒ½åˆäºŒä¸ºä¸€

![](https://static.zhufengpeixun.com/web32_1673150436062.jpg)

### 2.5 é›†ç¾¤åŒ– [#](#t625-é›†ç¾¤åŒ–)

* å•ç‚¹æœåŠ¡å™¨å¯èƒ½ä¼šå­˜åœ¨ä»¥ä¸‹å‡ ä¸ªé—®é¢˜ï¼š
  - å•ç‚¹æ•…éšœï¼šå•ç‚¹æœåŠ¡å™¨åªæœ‰ä¸€å°ï¼Œå¦‚æžœè¿™å°æœåŠ¡å™¨å‡ºçŽ°æ•…éšœï¼Œæ•´ä¸ªç³»ç»Ÿéƒ½ä¼šåœæ­¢å·¥ä½œï¼Œè¿™ä¼šå¯¼è‡´æœåŠ¡ä¸­æ–­
  - è®¡ç®—èƒ½åŠ›æœ‰é™ï¼šå•ç‚¹æœåŠ¡å™¨çš„è®¡ç®—èƒ½åŠ›æ˜¯æœ‰é™çš„ï¼Œæ— æ³•åº”å¯¹å¤§è§„æ¨¡çš„è®¡ç®—éœ€æ±‚
  - å¯æ‰©å±•æ€§å·®ï¼šå•ç‚¹æœåŠ¡å™¨çš„æ‰©å±•èƒ½åŠ›æœ‰é™ï¼Œå¦‚æžœæƒ³è¦æå‡è®¡ç®—èƒ½åŠ›ï¼Œå°±å¿…é¡»æ”¹é€ æˆ–è€…æ›¿æ¢çŽ°æœ‰çš„æœåŠ¡å™¨
* è¿™äº›é—®é¢˜å¯ä»¥é€šè¿‡é‡‡ç”¨æœåŠ¡å™¨é›†ç¾¤çš„æ–¹å¼æ¥è§£å†³

![](https://static.zhufengpeixun.com/web4_1673152233154.jpg)

## 3.åˆ›å»ºç”¨æˆ·å¾®æœåŠ¡ [#](#t73åˆ›å»ºç”¨æˆ·å¾®æœåŠ¡)

### 3.1 å¾®æœåŠ¡ [#](#t831-å¾®æœåŠ¡)

* å¾®æœåŠ¡æ˜¯ä¸€ç§æž¶æž„æ¨¡å¼ï¼Œå®ƒå°†å•ä¸ªåº”ç”¨ç¨‹åºåˆ’åˆ†ä¸ºå°çš„æœåŠ¡ï¼Œæ¯ä¸ªæœåŠ¡éƒ½ç‹¬ç«‹è¿è¡Œå¹¶ä¸”å¯ä»¥ä½¿ç”¨ä¸åŒçš„è¯­è¨€å¼€å‘ã€‚è¿™ç§æž¶æž„æ¨¡å¼ä½¿å¾—åº”ç”¨ç¨‹åºå˜å¾—æ›´å®¹æ˜“å¼€å‘ã€ç»´æŠ¤å’Œæ‰©å±•
* å¾®æœåŠ¡æž¶æž„é€šå¸¸ä¼šæœ‰è®¸å¤šä¸åŒçš„æœåŠ¡ï¼Œè¿™äº›æœåŠ¡å¯èƒ½ä½äºŽä¸åŒçš„æœºå™¨ä¸Šï¼Œå› æ­¤éœ€è¦ä½¿ç”¨æŸç§é€šä¿¡åè®®æ¥è¿›è¡Œé€šä¿¡
* å› ä¸º `RPC`åè®®æ¯” `HTTP`åè®®å…·æœ‰æ›´ä½Žçš„å»¶è¿Ÿå’Œæ›´é«˜çš„æ€§èƒ½ï¼Œæ‰€ä»¥ç”¨çš„æ›´å¤š

### 3.2 RPC [#](#t932-rpc)

* `RPC&#xFF08;Remote Procedure Call&#xFF09;` æ˜¯è¿œç¨‹è¿‡ç¨‹è°ƒç”¨çš„ç¼©å†™ï¼Œæ˜¯ä¸€ç§é€šä¿¡åè®®ï¼Œå…è®¸ç¨‹åºåœ¨ä¸åŒçš„è®¡ç®—æœºä¸Šç›¸äº’è°ƒç”¨è¿œç¨‹è¿‡ç¨‹ï¼Œå°±åƒè°ƒç”¨æœ¬åœ°è¿‡ç¨‹ä¸€æ ·

### 3.3 sofa-rpc-node [#](#t1033-sofa-rpc-node)

* `sofa-rpc-node` æ˜¯åŸºäºŽ Node.js çš„ä¸€ä¸ª RPC æ¡†æž¶ï¼Œæ”¯æŒå¤šç§åè®®

### 3.4 Protocol Buffers [#](#t1134-protocol-buffers)

* `Protocol Buffers`ï¼ˆç®€ç§° protobufï¼‰æ˜¯ Google å¼€å‘çš„ä¸€ç§æ•°æ®åºåˆ—åŒ–æ ¼å¼ï¼Œå¯ä»¥å°†ç»“æž„åŒ–æ•°æ®åºåˆ—åŒ–æˆäºŒè¿›åˆ¶æ ¼å¼ï¼Œå¹¶èƒ½å¤Ÿè·¨è¯­è¨€ä½¿ç”¨

### 3.5 Zookeeper [#](#t1235-zookeeper)

#### 3.5.1 ç®€ä»‹ [#](#t13351-ç®€ä»‹)

* ZooKeeper æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼åè°ƒæœåŠ¡ï¼Œæä¾›äº†ä¸€äº›ç®€å•çš„åˆ†å¸ƒå¼æœåŠ¡ï¼Œå¦‚é…ç½®ç»´æŠ¤ã€åå­—æœåŠ¡ã€ç»„æœåŠ¡ç­‰ã€‚å®ƒå¯ä»¥ç”¨äºŽç®¡ç†åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„æ•°æ®
* [Apache Zookeeper å®˜ç½‘](https://zookeeper.apache.org/releases.html)

#### 3.5.2 å®‰è£…å¯åŠ¨ [#](#t14352-å®‰è£…å¯åŠ¨)

*
  1. ä¸‹è½½ Zookeeper å®‰è£…åŒ…ï¼Œå¯ä»¥ä»Ž[Apache Zookeeper å®˜ç½‘](https://zookeeper.apache.org/releases.html)ä¸‹è½½æœ€æ–°ç‰ˆæœ¬çš„å®‰è£…åŒ…
*
  1. è§£åŽ‹å®‰è£…åŒ…ï¼Œå°†ä¸‹è½½çš„åŽ‹ç¼©åŒ…è§£åŽ‹åˆ°æŒ‡å®šçš„ç›®å½•ã€‚
*
  1. é…ç½®çŽ¯å¢ƒå˜é‡ï¼Œå°† Zookeeper å®‰è£…ç›®å½•æ·»åŠ åˆ°çŽ¯å¢ƒå˜é‡ä¸­
*
  1. ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œåœ¨å®‰è£…ç›®å½•ä¸‹çš„ `conf` ç›®å½•ä¸­æ‰¾åˆ° `zookeeper.properties` æ–‡ä»¶ï¼Œä¿®æ”¹ç›¸å…³é…ç½®
*
  1. å¯åŠ¨ Zookeeperï¼Œåœ¨å®‰è£…ç›®å½•ä¸‹è¿è¡Œå‘½ä»¤ `bin\zkServer.cmd` å³å¯å¯åŠ¨ Zookeeper

zookeeper\conf\zoo.cfg

```diff
+dataDir=./data
```

### 3.6 å¯åŠ¨æœåŠ¡ [#](#t1536-å¯åŠ¨æœåŠ¡)

* `logger` æ˜¯æ—¥å¿—è®°å½•å™¨ï¼Œç”¨äºŽè®°å½•æœåŠ¡å™¨è¿è¡Œæ—¶çš„æ—¥å¿—ä¿¡æ¯
* `registry` æ˜¯ä¸€ä¸ªæ³¨å†Œä¸­å¿ƒï¼Œç”¨äºŽç»´æŠ¤æœåŠ¡çš„æ³¨å†Œä¿¡æ¯ï¼Œå¸®åŠ©æœåŠ¡èŠ‚ç‚¹å’Œå®¢æˆ·ç«¯æ‰¾åˆ°å¯¹æ–¹ã€‚
* `server` è¡¨ç¤ºæœåŠ¡ç«¯ã€‚æœåŠ¡ç«¯æ˜¯æä¾›æœåŠ¡çš„èŠ‚ç‚¹ï¼Œå®ƒä¼šå°†è‡ªå·±æ‰€æä¾›çš„æœåŠ¡æ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒï¼Œå¹¶ç­‰å¾…å®¢æˆ·ç«¯çš„è°ƒç”¨ã€‚æœåŠ¡ç«¯é€šå¸¸ä¼šå®žçŽ°å…·ä½“çš„ä¸šåŠ¡é€»è¾‘ï¼Œå¹¶ä½¿ç”¨ `RPC` æˆ–å…¶ä»–é€šä¿¡åè®®ä¸Žå®¢æˆ·ç«¯è¿›è¡Œé€šä¿¡
* `server` çš„ `addService` æ–¹æ³•æŽ¥å—ä¸¤ä¸ªå‚æ•°ï¼šæœåŠ¡æŽ¥å£å’ŒæœåŠ¡å®žçŽ°ã€‚æœåŠ¡æŽ¥å£æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå…¶ä¸­åŒ…å«äº†æœåŠ¡çš„åç§°ä¿¡æ¯ã€‚æœåŠ¡å®žçŽ°æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå…¶ä¸­åŒ…å«äº†å…·ä½“å®žçŽ°æœåŠ¡æ–¹æ³•çš„å‡½æ•°
* RPC æœåŠ¡å™¨çš„ `start` æ–¹æ³•ï¼Œç”¨äºŽå¯åŠ¨æœåŠ¡å™¨
* RPC æœåŠ¡å™¨çš„ `publish` æ–¹æ³•ï¼Œç”¨äºŽå‘æ³¨å†Œä¸­å¿ƒæ³¨å†ŒæœåŠ¡ã€‚è¿™æ ·ï¼Œå®¢æˆ·ç«¯å°±å¯ä»¥é€šè¿‡æ³¨å†Œä¸­å¿ƒèŽ·å–æœåŠ¡çš„åœ°å€å’Œç«¯å£ï¼Œå¹¶ç›´æŽ¥å‘æœåŠ¡å™¨å‘èµ·è°ƒç”¨

#### 3.6.1 å®‰è£… [#](#t16361-å®‰è£…)

```js
npm install mysql2 sofa-rpc-node --save
```

#### 3.6.2 user\package.json [#](#t17362-userpackagejson)

user\package.json

```diff
{
    "name": "user",
    "version": "1.0.0",
    "description": "",
    "main": "index.js",
+ "scripts": {
+     "dev": "nodemon index.js"
+ },
    "keywords": [],
    "author": "",
    "license": "MIT",
    "dependencies": {
        "sofa-rpc-node": "^2.8.0"
    }
}
```

#### 3.6.3 user\index.js [#](#t18363-userindexjs)

user\index.js

```js
const { server: { RpcServer }, registry: { ZookeeperRegistry } } = require('sofa-rpc-node');
const mysql = require('mysql2/promise');
let connection;

const logger = console;

const registry = new ZookeeperRegistry({
    logger,
    address: '127.0.0.1:2181',
    connectTimeout: 1000 * 60 * 60 * 24,
});

const server = new RpcServer({
    logger,
    registry,
    port: 10000
});

server.addService({
    interfaceName: 'com.zhufeng.user'
}, {
    async getUserInfo(userId) {
        const [rows] = await connection.execute(`SELECT id,username,avatar,password,phone FROM user WHERE id=${userId} limit 1`);
        return rows[0];
    }
});

(async function () {
    connection = await mysql.createConnection({
        host: 'localhost',
        user: 'root',
        password: 'root',
        database: 'bff'
    });
    await server.start();
    await server.publish();
     console.log(`ç”¨æˆ·å¾®æœåŠ¡å‘å¸ƒæˆåŠŸ`);
})();

```

#### 3.6.4 client.js [#](#t19364-clientjs)

user\client.js

```js
const { client: { RpcClient }, registry: { ZookeeperRegistry } } = require('sofa-rpc-node');

const logger = console;

const registry = new ZookeeperRegistry({
    logger,
    address: '127.0.0.1:2181',
});
(async function () {

    const client = new RpcClient({ logger, registry });

    const userConsumer = client.createConsumer({

        interfaceName: 'com.zhufeng.user'
    });

    await userConsumer.ready();

    const result = await userConsumer.invoke('getUserInfo', [1], { responseTimeout: 3000 });

    console.log(result);
    process.exit(0);
})()
```

## 4.åˆ›å»ºæ–‡ç« å¾®æœåŠ¡ [#](#t204åˆ›å»ºæ–‡ç« å¾®æœåŠ¡)

### 4.1 å®‰è£… [#](#t2141-å®‰è£…)

```js
npm install mysql2 sofa-rpc-node --save
```

### 4.2 article\package.json [#](#t2242-articlepackagejson)

article\package.json

```diff
{
    "name": "user",
    "version": "1.0.0",
    "description": "",
    "main": "index.js",
    "scripts": {
+    "dev": "nodemon index.js"
    },
    "keywords": [],
    "author": "",
    "license": "MIT",
    "dependencies": {
        "mysql2": "^2.3.3",
        "sofa-rpc-node": "^2.8.0"
    }
}
```

### 4.3 article\index.js [#](#t2343-articleindexjs)

article\index.js

```js
const { server: { RpcServer }, registry: { ZookeeperRegistry } } = require('sofa-rpc-node');
const mysql = require('mysql2/promise');
let connection;

const logger = console;

const registry = new ZookeeperRegistry({
    logger,
    address: '127.0.0.1:2181',
    connectTimeout: 1000 * 60 * 60 * 24,
});

const server = new RpcServer({
    logger,
    registry,
    port: 20000
});

server.addService({
    interfaceName: 'com.zhufeng.post'
}, {
    async getPostCount(userId) {
        const [rows] = await connection.execute(`SELECT count(*) as postCount FROM post WHERE user_id=${userId} limit 1`);
        return rows[0].postCount;
    }
});

(async function () {
    connection = await mysql.createConnection({
        host: 'localhost',
        user: 'root',
        password: 'root',
        database: 'bff'
    });
    await server.start();
    await server.publish();
    console.log(`æ–‡ç« å¾®æœåŠ¡å‘å¸ƒæˆåŠŸ`);
})();
```

### 4.4 client.js [#](#t2444-clientjs)

article\client.js

```js
const { client: { RpcClient }, registry: { ZookeeperRegistry } } = require('sofa-rpc-node');

const logger = console;

const registry = new ZookeeperRegistry({
    logger,
    address: '127.0.0.1:2181',
});
(async function () {

    const client = new RpcClient({ logger, registry });

    const consumer = client.createConsumer({

        interfaceName: 'com.zhufeng.post'
    });

    await consumer.ready();

    const result = await consumer.invoke('getPostCount', [1], { responseTimeout: 3000 });

    console.log(result);
    process.exit(0);
})()
```

## 5.åˆ›å»ºBFF [#](#t255åˆ›å»ºbff)

### 5.1 å®‰è£… [#](#t2651-å®‰è£…)

```js
npm install koa koa-router koa-logger sofa-rpc-node lru-cache ioredis amqplib fs-extra --save
```

è®¿é—®åœ°å€

```js
http:
```

### 5.2 bff\package.json [#](#t2752-bffpackagejson)

bff\package.json

```diff
{
    "name": "bff",
    "version": "1.0.0",
    "description": "",
    "main": "index.js",
    "scripts": {
+    "dev": "nodemon index.js",
+    "start": "pm2 start index.js --name bff"
    },
    "keywords": [],
    "author": "",
    "license": "ISC",
    "dependencies": {
        "koa": "^2.14.1",
        "koa-logger": "^3.2.1",
        "koa-router": "^12.0.0",
        "sofa-rpc-node": "^2.8.0"
    }
}
```

### 5.3 bff\index.js [#](#t2853-bffindexjs)

bff\index.js

```js
const Koa = require('koa');
const router = require('koa-router')();
const logger = require('koa-logger');
const rpcMiddleware = require('./middleware/rpc');
const app = new Koa();
app.use(logger());
app.use(rpcMiddleware({

    interfaceNames: [
        'com.zhufeng.user',
        'com.zhufeng.post'
    ]
}));
router.get('/', async ctx => {
    const userId = ctx.query.userId;
    const { rpcConsumers: { user, post } } = ctx;
    const [userInfo, postCount] = await Promise.all([
        user.invoke('getUserInfo', [userId]),
        post.invoke('getPostCount', [userId])
    ]);
    ctx.body = { userInfo, postCount }
});
app.use(router.routes()).use(router.allowedMethods());
app.listen(3000, () => {
    console.log('bff server is running at 3000');
});
```

### 5.4 rpc.js [#](#t2954-rpcjs)

bff\middleware\rpc.js

```js
const { client: { RpcClient }, registry: { ZookeeperRegistry } } = require('sofa-rpc-node');
const rpcMiddleware = (options = {}) => {
    return async function (ctx, next) {
        const logger = options.logger || console;

        const registry = new ZookeeperRegistry({
            logger,
            address: options.address || '127.0.0.1:2181',
        });

        const client = new RpcClient({ logger, registry });
        const interfaceNames = options.interfaceNames || [];
        const rpcConsumers = {};
        for (let i = 0; i < interfaceNames.length; i++) {
            const interfaceName = interfaceNames[i];

            const consumer = client.createConsumer({
                interfaceName,
            });

            await consumer.ready();
            rpcConsumers[interfaceName.split('.').pop()] = consumer;
        }
        ctx.rpcConsumers = rpcConsumers;
        await next();
    }
};
module.exports = rpcMiddleware;
```

### 5.5 bff\index.js [#](#t3055-bffindexjs)

æ•°æ®å¤„ç†

```diff
const Koa = require('koa');
const router = require('koa-router')();
const logger = require('koa-logger');
const rpcMiddleware = require('./middleware/rpc');
const app = new Koa();
app.use(logger());
app.use(rpcMiddleware({
    interfaceNames: [
        'com.zhufeng.user',
        'com.zhufeng.post'
    ]
}));
router.get('/', async ctx => {
    const userId = ctx.query.userId;
    const { rpcConsumers: { user, post } } = ctx;
    const [userInfo, postCount] = await Promise.all([
        user.invoke('getUserInfo', [userId]),
        post.invoke('getPostCount', [userId])
    ]);
+ // è£å‰ªæ•°æ®
+ delete userInfo.password;
+ // æ•°æ®è„±æ•
+ userInfo.phone = userInfo.phone.replace(/(\d{3})\d{4}(\d{4})/, '$1****$2');
+ // æ•°æ®é€‚é…
+ userInfo.avatar = "http://www.zhufengpeixun.cn/"+userInfo.avatar,
    ctx.body = { userInfo, postCount }
});
app.use(router.routes()).use(router.allowedMethods());
app.listen(3000, () => {
    console.log('bff server is running at 3000');
});
```

## 6.ç¼“å­˜ [#](#t316ç¼“å­˜)

* BFF ä½œä¸ºå‰ç«¯åº”ç”¨å’ŒåŽç«¯ç³»ç»Ÿä¹‹é—´çš„æŠ½è±¡å±‚ï¼Œæ‰¿æ‹…äº†å¤§é‡çš„è¯·æ±‚è½¬å‘å’Œæ•°æ®è½¬æ¢å·¥ä½œã€‚ä½¿ç”¨å¤šçº§ç¼“å­˜å¯ä»¥å¸®åŠ© BFF å‡å°‘å¯¹åŽç«¯ç³»ç»Ÿçš„è®¿é—®ï¼Œä»Žè€Œæé«˜åº”ç”¨çš„å“åº”é€Ÿåº¦
* å½“ BFF æ”¶åˆ°ä¸€ä¸ªè¯·æ±‚æ—¶ï¼Œé¦–å…ˆä¼šæ£€æŸ¥å†…å­˜ç¼“å­˜ä¸­æ˜¯å¦å­˜åœ¨å¯¹åº”çš„æ•°æ®ï¼Œå¦‚æžœæœ‰å°±ç›´æŽ¥è¿”å›žæ•°æ®ã€‚å¦‚æžœå†…å­˜ç¼“å­˜ä¸­æ²¡æœ‰æ•°æ®ï¼Œå°±ä¼šæ£€æŸ¥Redisç¼“å­˜ï¼Œå¦‚æžœRedisç¼“å­˜ä¸­æœ‰æ•°æ®å°±è¿”å›žæ•°æ®ï¼Œå¹¶å°†æ•°æ®å†™å…¥å†…å­˜ç¼“å­˜ã€‚å¦‚æžœæœ¬åœ°ç¼“å­˜ä¸­ä¹Ÿæ²¡æœ‰æ•°æ®ï¼Œå°±ä¼šå‘åŽç«¯ç³»ç»Ÿå‘èµ·è¯·æ±‚ï¼Œå¹¶å°†æ•°æ®å†™å…¥Redisç¼“å­˜å’Œå†…å­˜ç¼“å­˜

### 6.1 å¤šçº§ç¼“å­˜ [#](#t3261-å¤šçº§ç¼“å­˜)

* å¤šçº§ç¼“å­˜ï¼ˆmulti-level cacheï¼‰æ˜¯æŒ‡ç³»ç»Ÿä¸­ä½¿ç”¨äº†å¤šä¸ªç¼“å­˜å±‚æ¥å­˜å‚¨æ•°æ®çš„æŠ€æœ¯ã€‚è¿™äº›ç¼“å­˜å±‚çš„ä¼˜å…ˆçº§é€šå¸¸æ˜¯ä¾æ¬¡é€’å‡çš„ï¼Œå³æœ€å¿«çš„ç¼“å­˜å±‚ä½äºŽæœ€é¡¶å±‚ï¼Œæœ€æ…¢çš„ç¼“å­˜å±‚ä½äºŽæœ€åº•å±‚

### 6.2 LRU [#](#t3362-lru)

* LRUï¼ˆLeast Recently Usedï¼‰æ˜¯ä¸€ç§å¸¸ç”¨çš„é«˜é€Ÿç¼“å­˜æ·˜æ±°ç®—æ³•ï¼Œå®ƒçš„åŽŸç†æ˜¯å°†æœ€è¿‘ä½¿ç”¨è¿‡çš„æ•°æ®æˆ–é¡µé¢ä¿ç•™åœ¨ç¼“å­˜ä¸­ï¼Œè€Œæœ€å°‘ä½¿ç”¨çš„æ•°æ®æˆ–é¡µé¢å°†è¢«æ·˜æ±°ã€‚è¿™æ ·åšçš„ç›®çš„æ˜¯ä¸ºäº†æœ€å¤§åŒ–ç¼“å­˜çš„å‘½ä¸­çŽ‡ï¼Œå³ä½¿ç”¨ç¼“å­˜å°½å¯èƒ½å¤šåœ°æ»¡è¶³ç”¨æˆ·çš„è¯·æ±‚

### 6.3 redis [#](#t3463-redis)

* Redis æ˜¯ä¸€ç§å¼€æºçš„å†…å­˜æ•°æ®å­˜å‚¨ç³»ç»Ÿï¼Œå¯ä»¥ä½œä¸ºæ•°æ®åº“ã€ç¼“å­˜å’Œæ¶ˆæ¯ä¸­é—´ä»¶ä½¿ç”¨
* Redis è¿è¡Œåœ¨å†…å­˜ä¸­ï¼Œå› æ­¤å®ƒçš„è¯»å†™é€Ÿåº¦éžå¸¸å¿«
* `ioredis` æ˜¯ä¸€ä¸ªåŸºäºŽ Node.js çš„ Redis å®¢æˆ·ç«¯ï¼Œæä¾›äº†å¯¹ Redis å‘½ä»¤çš„é«˜åº¦å°è£…å’Œæ”¯æŒ
* [redis](https://github.com/tporadowski/redis/releases)
* [Redis-x64-5.0.14.1](https://static.zhufengpeixun.com/Redisx6450141_1673102444438.zip)

### 6.4 ä½¿ç”¨ç¼“å­˜ [#](#t3564-ä½¿ç”¨ç¼“å­˜)

#### 6.4.1 bff\index.js [#](#t36641-bffindexjs)

bff\index.js

```diff
const Koa = require('koa');
const router = require('koa-router')();
const logger = require('koa-logger');
const rpcMiddleware = require('./middleware/rpc');
+const cacheMiddleware = require('./middleware/cache');
const app = new Koa();
app.use(logger());
app.use(rpcMiddleware({
    interfaceNames: [
        'com.zhufeng.user',
        'com.zhufeng.post'
    ]
}));
+app.use(cacheMiddleware({}));
router.get('/profile', async ctx => {
    const userId = ctx.query.userId;
    const { rpcConsumers: { user, post } } = ctx;
+ const cacheKey = `${ctx.method}#${ctx.path}#${userId}`;
+ let cacheData = await ctx.cache.get(cacheKey);
+ if (cacheData) {
+     ctx.body = cacheData;
+     return;
+ }
    const [userInfo, postCount] = await Promise.all([
        user.invoke('getUserInfo', [userId]),
        post.invoke('getPostCount', [userId])
    ]);
  // è£å‰ªæ•°æ®
  delete userInfo.password;
  // æ•°æ®è„±æ•
  userInfo.phone = userInfo.phone.replace(/(\d{3})\d{4}(\d{4})/, '$1****$2');
  // æ•°æ®é€‚é…
  userInfo.avatar = "http://www.zhufengpeixun.cn/" + userInfo.avatar;
+ cacheData = { userInfo, postCount };
+ await ctx.cache.set(cacheKey, cacheData);// keys *
+ ctx.body = cacheData
});
app.use(router.routes()).use(router.allowedMethods());
app.listen(3000, () => {
    console.log('bff server is running at 3000');
});
```

#### 6.4.2 cache.js [#](#t37642-cachejs)

bff\middleware\cache.js

```js
const LRUCache = require('lru-cache');
const Redis = require('ioredis');
class CacheStore {
    constructor() {
        this.stores = [];
    }
    add(store) {
        this.stores.push(store);
        return this;
    }
    async get(key) {
        for (const store of this.stores) {
            const value = await store.get(key);
            if (value !== undefined) {
                return value;
            }
        }
    }
    async set(key, value) {
        for (const store of this.stores) {
            await store.set(key, value);
        }
    }
}
class MemoryStore {
    constructor() {
        this.cache = new LRUCache({
            max: 100,
            ttl: 1000 * 60 * 60 * 24
        });
    }
    async get(key) {
        return this.cache.get(key);
    }
    async set(key, value) {
        this.cache.set(key, value);
    }
}
class RedisStore {
    constructor(options) {
        this.client = new Redis(options);
    }
    async get(key) {
        let value = await this.client.get(key);
        return value ? JSON.parse(value) : undefined;
    }
    async set(key, value) {
        await this.client.set(key, JSON.stringify(value));
    }
}
const cacheMiddleware = (options = {}) => {
    return async function (ctx, next) {
        const cacheStore = new CacheStore();
        cacheStore.add(new MemoryStore());
        const redisStore = new RedisStore(options);
        cacheStore.add(redisStore);
        ctx.cache = cacheStore;
        await next();
    };
};
module.exports = cacheMiddleware;
```

## 7.æ¶ˆæ¯é˜Ÿåˆ— [#](#t387æ¶ˆæ¯é˜Ÿåˆ—)

* æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆMessage Queueï¼‰ç”¨äºŽåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ä¼ é€’æ•°æ®ã€‚å®ƒçš„ç‰¹ç‚¹æ˜¯å¯ä»¥å°†æ¶ˆæ¯å‘é€è€…å’ŒæŽ¥æ”¶è€…è§£è€¦ï¼Œä½¿å¾—æ¶ˆæ¯ç”Ÿäº§è€…å’Œæ¶ˆæ¯æ¶ˆè´¹è€…å¯ä»¥ç‹¬ç«‹çš„å¼€å‘å’Œéƒ¨ç½²

### 7.1 å¼•å…¥åŽŸå›  [#](#t3971-å¼•å…¥åŽŸå› )

* åœ¨ BFF ä¸­ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆmessage queueï¼‰æœ‰å‡ ä¸ªåŽŸå› ï¼š
  - å¤§å¹¶å‘ï¼šæ¶ˆæ¯é˜Ÿåˆ—å¯ä»¥å¸®åŠ©åº”å¯¹å¤§å¹¶å‘çš„è¯·æ±‚ï¼ŒBFF å¯ä»¥å°†è¯·æ±‚å†™å…¥æ¶ˆæ¯é˜Ÿåˆ—ï¼Œç„¶åŽåŽç«¯æœåŠ¡å¯ä»¥ä»Žæ¶ˆæ¯é˜Ÿåˆ—ä¸­è¯»å–è¯·æ±‚å¹¶å¤„ç†
  - è§£è€¦ï¼šæ¶ˆæ¯é˜Ÿåˆ—å¯ä»¥å¸®åŠ©è§£è€¦ BFF å’ŒåŽç«¯æœåŠ¡ï¼ŒBFF ä¸éœ€è¦å…³å¿ƒåŽç«¯æœåŠ¡çš„å…·ä½“å®žçŽ°ï¼Œåªéœ€è¦å°†è¯·æ±‚å†™å…¥æ¶ˆæ¯é˜Ÿåˆ—ï¼ŒåŽç«¯æœåŠ¡è´Ÿè´£ä»Žæ¶ˆæ¯é˜Ÿåˆ—ä¸­è¯»å–è¯·æ±‚å¹¶å¤„ç†
  - å¼‚æ­¥ï¼šæ¶ˆæ¯é˜Ÿåˆ—å¯ä»¥å¸®åŠ©å®žçŽ°å¼‚æ­¥è°ƒç”¨ï¼ŒBFF å¯ä»¥å°†è¯·æ±‚å†™å…¥æ¶ˆæ¯é˜Ÿåˆ—ï¼Œç„¶åŽç«‹å³è¿”å›žå“åº”ç»™å‰ç«¯åº”ç”¨ï¼ŒåŽç«¯æœåŠ¡åœ¨åŽå°å¤„ç†è¯·æ±‚
    + æµé‡å‰Šå³°ï¼šæ¶ˆæ¯é˜Ÿåˆ—å¯ä»¥å¸®åŠ©æµé‡å‰Šå³°ï¼ŒBFF å¯ä»¥å°†è¯·æ±‚å†™å…¥æ¶ˆæ¯é˜Ÿåˆ—ï¼Œç„¶åŽåŽç«¯æœåŠ¡å¯ä»¥åœ¨åˆé€‚çš„æ—¶å€™å¤„ç†è¯·æ±‚ï¼Œä»Žè€Œç¼“è§£çž¬æ—¶é«˜å³°æµé‡å¸¦æ¥çš„åŽ‹åŠ›

### 7.2 RabbitMQ [#](#t4072-rabbitmq)

* `RabbitMQ`æ˜¯ä¸€ä¸ªæ¶ˆæ¯ä»£ç†ï¼Œå®ƒå¯ä»¥ç”¨æ¥åœ¨æ¶ˆæ¯ç”Ÿäº§è€…å’Œæ¶ˆæ¯æ¶ˆè´¹è€…ä¹‹é—´ä¼ é€’æ¶ˆæ¯
* RabbitMQçš„å·¥ä½œæµç¨‹å¦‚ä¸‹ï¼š
  - æ¶ˆæ¯ç”Ÿäº§è€…å°†æ¶ˆæ¯å‘é€åˆ° `RabbitMQ`æœåŠ¡å™¨
  - `RabbitMQ`æœåŠ¡å™¨å°†æ¶ˆæ¯ä¿å­˜åˆ°é˜Ÿåˆ—ä¸­
  - æ¶ˆæ¯æ¶ˆè´¹è€…ä»Žé˜Ÿåˆ—ä¸­è¯»å–æ¶ˆæ¯
  - å½“æ¶ˆæ¯æ¶ˆè´¹è€…å¤„ç†å®Œæ¶ˆæ¯åŽ `RabbitMQ`æœåŠ¡å™¨å°†æ¶ˆæ¯åˆ é™¤
* å®‰è£…å¯åŠ¨
  - åœ¨RabbitMQä¸‹è½½[å®˜ç½‘å®‰è£…åŒ…](https://www.rabbitmq.com/install-windows.html#installer)æˆ–[é•œåƒå®‰è£…åŒ…](https://static.zhufengpeixun.com/rabbitmqserver3116_1673104196680.exe)
  - åŒå‡»å®‰è£…åŒ…ï¼ŒæŒ‰ç…§æç¤ºè¿›è¡Œå®‰è£…,ç›´æŽ¥å°±å¯ä»¥å¯åŠ¨
    + å®‰è£…å‰è¿˜è¦å®‰è£…[Erlang](https://www.erlang.org/downloads),Erlangæ˜¯ä¸€ä¸ªç»“æž„åŒ–ï¼ŒåŠ¨æ€ç±»åž‹ç¼–ç¨‹è¯­è¨€ï¼Œå†…å»ºå¹¶è¡Œè®¡ç®—æ”¯æŒ

### 7.3 å®žçŽ° [#](#t4173-å®žçŽ°)

#### 7.3.2 bff\index.js [#](#t42732-bffindexjs)

bff\index.js

```diff
const Koa = require('koa');
const router = require('koa-router')();
const logger = require('koa-logger');
const rpcMiddleware = require('./middleware/rpc');
const cacheMiddleware = require('./middleware/cache');
+const mqMiddleware = require('./middleware/mq');
const app = new Koa();
app.use(logger());
app.use(rpcMiddleware({
    interfaceNames: [
        'com.zhufeng.user',
        'com.zhufeng.post'
    ]
}));
app.use(cacheMiddleware({}));
+app.use(mqMiddleware({ url: 'amqp://localhost' }));
router.get('/profile', async ctx => {
    const userId = ctx.query.userId;
+    ctx.channels.logger.sendToQueue('logger', Buffer.from(JSON.stringify({
+        method: ctx.method,
+        path: ctx.path,
+        userId
+    })));
    const { rpcConsumers: { user, post } } = ctx;
    const cacheKey = `${ctx.method}#${ctx.path}#${userId}`;
    let cacheData = await ctx.cache.get(cacheKey);
    if (cacheData) {
        ctx.body = cacheData;
        return;
    }
    const [userInfo, postCount] = await Promise.all([
        user.invoke('getUserInfo', [userId]),
        post.invoke('getPostCount', [userId])
    ]);
      // è£å‰ªæ•°æ®
  delete userInfo.password;
  // æ•°æ®è„±æ•
  userInfo.phone = userInfo.phone.replace(/(\d{3})\d{4}(\d{4})/, '$1****$2');
  // æ•°æ®é€‚é…
  userInfo.avatar = "http://www.zhufengpeixun.cn/" + userInfo.avatar,
    cacheData = { userInfo, postCount };
  await ctx.cache.set(cacheKey, cacheData);// keys *
  ctx.body = cacheData
});
app.use(router.routes()).use(router.allowedMethods());
app.listen(3000, () => {
    console.log('bff server is running at 3000');
});
```

#### 7.3.2 mq.js [#](#t43732-mqjs)

bff\middleware\mq.js

```js
const amqp = require('amqplib');
const mqMiddleware = (options = {}) => {
    return async (ctx, next) => {

        const rabbitMQClient = await amqp.connect(options.url || 'amqp://localhost');

        const logger = await rabbitMQClient.createChannel();

        await logger.assertQueue('logger');
        ctx.channels = {
            logger
        };
        await next();
    };
};
module.exports = mqMiddleware;
```

#### 7.3.3 bff\logger.js [#](#t44733-bffloggerjs)

bff\logger.js

```js
const amqplib = require('amqplib');
const fs = require('fs-extra');
const path = require('path');
(async () => {
    const conn = await amqplib.connect('amqp://localhost');
    const loggerChannel = await conn.createChannel();
    await loggerChannel.assertQueue('logger');
    loggerChannel.consume('logger', async (event) => {
        const message = JSON.parse(event.content.toString());
        await fs.appendFile(path.join(__dirname, 'logger.txt'), JSON.stringify(message) + '\n');
    });
})();
```

## 8.Serverless [#](#t458serverless)

### 8.1 BFFé—®é¢˜ [#](#t4681-bffé—®é¢˜)

* å¤æ‚æ€§å¢žåŠ ï¼šæ·»åŠ  BFF å±‚ä¼šå¢žåŠ ç³»ç»Ÿçš„å¤æ‚æ€§ï¼Œå› ä¸ºå®ƒéœ€è¦åœ¨åŽç«¯ API å’Œå‰ç«¯åº”ç”¨ç¨‹åºä¹‹é—´å¤„ç†è¯·æ±‚å’Œå“åº”
* æ€§èƒ½é—®é¢˜ï¼šå¦‚æžœ BFF å±‚çš„å®žçŽ°ä¸å½“ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ€§èƒ½é—®é¢˜ï¼Œå› ä¸ºå®ƒéœ€è¦åœ¨åŽç«¯ API å’Œå‰ç«¯åº”ç”¨ç¨‹åºä¹‹é—´ä¼ è¾“å¤§é‡æ•°æ®
* å®‰å…¨é£Žé™©ï¼šå¦‚æžœ BFF å±‚æœªå¾—åˆ°æ­£ç¡®ä¿æŠ¤ï¼Œå¯èƒ½ä¼šå¯¼è‡´å®‰å…¨é£Žé™©ï¼Œå› ä¸ºå®ƒå¯èƒ½ä¼šæš´éœ²æ•æ„Ÿæ•°æ®
* ç»´æŠ¤æˆæœ¬ï¼šBFF å±‚éœ€è¦ç»´æŠ¤å’Œæ›´æ–°ï¼Œè¿™ä¼šå¢žåŠ ç»´æŠ¤æˆæœ¬
* æµ‹è¯•å¤æ‚æ€§ï¼šç”±äºŽ BFF å±‚éœ€è¦åœ¨åŽç«¯ API å’Œå‰ç«¯åº”ç”¨ç¨‹åºä¹‹é—´è¿›è¡Œæµ‹è¯•ï¼Œå› æ­¤æµ‹è¯•å¯èƒ½ä¼šå˜å¾—æ›´åŠ å¤æ‚
* è¿ç»´é—®é¢˜ è¦æ±‚æœ‰å¼ºå¤§çš„æ—¥å¿—ã€æœåŠ¡å™¨ç›‘æŽ§ã€æ€§èƒ½ç›‘æŽ§ã€è´Ÿè½½å‡è¡¡ã€å¤‡ä»½å†—ç¾ã€ç›‘æŽ§æŠ¥è­¦å’Œå¼¹æ€§ä¼¸ç¼©æ‰©å®¹ç­‰

### 8.2 Serverless [#](#t4782-serverless)

* è¿™äº›é—®é¢˜å¯ä»¥é€šè¿‡[Serverless](https://docs.cloudbase.net/)æ¥è§£å†³
* Serverless = Faas (Function as a service) + Baas (Backend as a service)
* FaaSï¼ˆFunction-as-a-Serviceï¼‰æ˜¯æœåŠ¡å•†æä¾›ä¸€ä¸ªå¹³å°ã€æä¾›ç»™ç”¨æˆ·å¼€å‘ã€è¿è¡Œç®¡ç†è¿™äº›å‡½æ•°çš„åŠŸèƒ½ï¼Œè€Œæ— éœ€æ­å»ºå’Œç»´æŠ¤åŸºç¡€æ¡†æž¶ï¼Œæ˜¯ä¸€ç§äº‹ä»¶é©±åŠ¨ç”±æ¶ˆæ¯è§¦å‘çš„å‡½æ•°æœåŠ¡
* BaaSï¼ˆBackend-as-a-Serviceï¼‰åŽç«¯å³æœåŠ¡ï¼ŒåŒ…å«äº†åŽç«¯æœåŠ¡ç»„ä»¶ï¼Œå®ƒæ˜¯åŸºäºŽ API çš„ç¬¬ä¸‰æ–¹æœåŠ¡ï¼Œç”¨äºŽå®žçŽ°åº”ç”¨ç¨‹åºä¸­çš„æ ¸å¿ƒåŠŸèƒ½ï¼ŒåŒ…å«å¸¸ç”¨çš„æ•°æ®åº“ã€å¯¹è±¡å­˜å‚¨ã€æ¶ˆæ¯é˜Ÿåˆ—ã€æ—¥å¿—æœåŠ¡ç­‰ç­‰

![](https://static.zhufengpeixun.com/fassbass_1673160507846.png)

![](https://static.zhufengpeixun.com/Serverless_1673160406503.png)

### 8.3 Serverlessçš„ä¼˜åŠ¿ [#](#t4883-serverlessçš„ä¼˜åŠ¿)

* èŠ‚çœæˆæœ¬ï¼šåœ¨ä¼ ç»Ÿæž¶æž„ä¸­ï¼Œä½ éœ€è¦ä¸ºåº”ç”¨ç¨‹åºæ‰€ä½¿ç”¨çš„æœåŠ¡å™¨ä»˜è´¹ï¼Œå³ä½¿å®ƒä»¬æ²¡æœ‰è¢«ä½¿ç”¨ã€‚åœ¨ Serverless æž¶æž„ä¸­ï¼Œä½ ä»…éœ€ä¸ºå®žé™…ä½¿ç”¨çš„èµ„æºä»˜è´¹ï¼Œè¿™å¯ä»¥èŠ‚çœå¤§é‡æˆæœ¬
* æ›´å¿«çš„å¼€å‘å‘¨æœŸï¼šServerless æž¶æž„å…è®¸å¼€å‘äººå‘˜æ›´å¿«åœ°æž„å»ºå’Œéƒ¨ç½²åº”ç”¨ç¨‹åºï¼Œå› ä¸ºå®ƒä»¬å¯ä»¥æ›´å¿«åœ°èŽ·å¾—æ‰€éœ€çš„èµ„æº
* æ›´å¥½çš„å¯ä¼¸ç¼©æ€§ï¼šServerless æž¶æž„å¯ä»¥è‡ªåŠ¨æ‰©å±•æ¥æ»¡è¶³å¢žé•¿çš„æµé‡éœ€æ±‚ï¼Œæ— éœ€äººå·¥å¹²é¢„
* æ›´å¥½çš„å¯ç»´æŠ¤æ€§ï¼šåœ¨ Serverless æž¶æž„ä¸­ï¼Œä½ æ— éœ€æ‹…å¿ƒåº•å±‚åŸºç¡€æž¶æž„çš„ç»´æŠ¤ï¼Œå› ä¸ºè¿™äº›å·¥ä½œç”±äº‘æœåŠ¡æä¾›å•†è´Ÿè´£
* æ›´é«˜çš„å¯ç”¨æ€§ï¼šç”±äºŽ Serverless æž¶æž„å…·æœ‰è‡ªåŠ¨æ‰©å±•åŠŸèƒ½ï¼Œå› æ­¤å®ƒå¯ä»¥æ›´å¥½åœ°åº”å¯¹çªå‘æµé‡ï¼Œä»Žè€Œæé«˜åº”ç”¨ç¨‹åºçš„å¯ç”¨æ€§

### 8.4 Serverlessçš„ç¼ºç‚¹ [#](#t4984-serverlessçš„ç¼ºç‚¹)

* å¤æ‚æ€§ï¼šServerless æž¶æž„å¯èƒ½ä¼šä½¿åº”ç”¨ç¨‹åºçš„ä½“ç³»ç»“æž„å˜å¾—æ›´åŠ å¤æ‚ï¼Œå› ä¸ºå®ƒéœ€è¦å°†åº”ç”¨ç¨‹åºæ‹†åˆ†ä¸ºè®¸å¤šå°åž‹å‡½æ•°
* æ€§èƒ½é—®é¢˜ï¼šåœ¨æŸäº›æƒ…å†µä¸‹ï¼ŒServerless æž¶æž„å¯èƒ½ä¼šå¯¼è‡´æ€§èƒ½é—®é¢˜ï¼Œå› ä¸ºå‡½æ•°æ‰§è¡Œéœ€è¦é¢å¤–çš„æ—¶é—´æ¥å¯åŠ¨å’Œç»ˆæ­¢
* é™åˆ¶ï¼šæ¯ä¸ªå‡½æ•°éƒ½æœ‰èµ„æºé™åˆ¶ï¼Œå› æ­¤éœ€è¦ä»”ç»†è§„åˆ’åº”ç”¨ç¨‹åºçš„ä½“ç³»ç»“æž„ï¼Œä»¥å…è¶…å‡ºè¿™äº›é™åˆ¶
* ä¾èµ–äº‘æœåŠ¡æä¾›å•†ï¼šä½¿ç”¨ Serverless æž¶æž„éœ€è¦ä¾èµ–äº‘æœåŠ¡æä¾›å•†ï¼Œå› æ­¤å¦‚æžœè¿™äº›æœåŠ¡å‡ºçŽ°æ•…éšœï¼Œå¯èƒ½ä¼šå¯¹åº”ç”¨ç¨‹åºé€ æˆå½±å“
* è°ƒè¯•å›°éš¾ï¼šç”±äºŽ Serverless æž¶æž„ä½¿ç”¨è®¸å¤šå°åž‹å‡½æ•°ï¼Œå› æ­¤è°ƒè¯•å¯èƒ½ä¼šå˜å¾—æ›´åŠ å›°éš¾

## 9.GraphQL [#](#t509graphql)

* `GraphQL`æ˜¯ä¸€ç§ç”¨äºŽAPIçš„æŸ¥è¯¢è¯­è¨€ï¼Œå®ƒå…è®¸å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯è¯·æ±‚ç‰¹å®šçš„æ•°æ®ï¼Œè€Œä¸æ˜¯æœåŠ¡ç«¯å°†æ‰€æœ‰å¯èƒ½çš„æ•°æ®å…¨éƒ¨è¿”å›žã€‚è¿™æ ·ï¼Œå®¢æˆ·ç«¯å¯ä»¥æ›´ç²¾ç¡®åœ°èŽ·å–æ‰€éœ€çš„æ•°æ®ï¼Œå¹¶ä¸”æœåŠ¡ç«¯å¯ä»¥æ›´æœ‰æ•ˆåœ°æ»¡è¶³è¯·æ±‚
* `GraphQL`å¯ä»¥è®©å®¢æˆ·ç«¯è‡ªå·±å®šä¹‰æ‰€éœ€çš„æ•°æ®ç»“æž„ï¼Œå¯ä»¥çµæ´»åœ°èŽ·å–æ‰€éœ€çš„æ•°æ®ã€‚è¿™å¯¹äºŽå¤šç«¯åº”ç”¨æ¥è¯´éžå¸¸æ–¹ä¾¿ï¼Œå› ä¸ºæ¯ä¸€ä¸ªå®¢æˆ·ç«¯å¯èƒ½æœ‰ä¸åŒçš„æ•°æ®éœ€æ±‚ï¼Œä½¿ç”¨GraphQLå¯ä»¥è®©æ¯ä¸ªå®¢æˆ·ç«¯è‡ªå·±å®šä¹‰æ‰€éœ€çš„æ•°æ®ç»“æž„
* `GraphQL`å¯ä»¥è®©BFFæœåŠ¡å±‚ä»Žä¸åŒçš„æ•°æ®æºèŽ·å–æ•°æ®ï¼Œå¹¶å°†å®ƒä»¬ç»„åˆèµ·æ¥è¿”å›žç»™å®¢æˆ·ç«¯ã€‚è¿™å¯¹äºŽåœ¨BFFæž¶æž„ä¸­æ›´å¥½åœ°ç»„ç»‡æ•°æ®æ˜¯å¾ˆæœ‰å¸®åŠ©çš„ï¼Œå› ä¸ºä½ å¯ä»¥åœ¨BFFå±‚ä¸­ç»„åˆæ¥è‡ªä¸åŒæ•°æ®æºçš„æ•°æ®ï¼Œè€Œä¸ç”¨åœ¨å®¢æˆ·ç«¯ä¸­å†åšä¸€æ¬¡ç»„åˆ

### 9.1 Apollo Server [#](#t5191-apollo-server)

* `Apollo Server`æ˜¯ä¸€ä¸ªç”¨äºŽæž„å»ºGraphQL APIçš„å¼€æºæœåŠ¡å™¨æ¡†æž¶ã€‚å®ƒæ”¯æŒå¤šç§ç¼–ç¨‹è¯­è¨€ï¼Œå…è®¸ä½ ä½¿ç”¨åŒä¸€ç§æ–¹å¼æ¥è®¿é—®ä¸åŒçš„åŽç«¯æ•°æ®æºï¼Œå¹¶ä¸”å…·æœ‰è‰¯å¥½çš„æ‰©å±•æ€§
* `Apollo Server`æ˜¯ä¸€ç§å®žçŽ°GraphQLæœåŠ¡ç«¯çš„æ–¹æ³•ï¼Œå®ƒæä¾›äº†ä¸€äº›å·¥å…·å’ŒåŠŸèƒ½ï¼Œå¸®åŠ©ä½ æ›´è½»æ¾åœ°æž„å»ºå’Œéƒ¨ç½²GraphQL APIã€‚å®ƒè¿˜æä¾›äº†ä¸€äº›é¢å¤–çš„åŠŸèƒ½ï¼Œå¦‚ç¼“å­˜ã€èº«ä»½éªŒè¯å’Œæ¨¡æ‹Ÿæ•°æ®ï¼Œå¸®åŠ©ä½ æ›´å¿«é€Ÿåœ°å¼€å‘å’Œæµ‹è¯•ä½ çš„API

### 9.2 GraphQL schema language [#](#t5292-graphql-schema-language)

* [schema](https://graphql.org/learn/schema/)
* `GraphQL schema language`æ˜¯ä¸€ç§ç”¨æ¥å®šä¹‰GraphQL APIçš„è¯­è¨€ã€‚å®ƒå¯ä»¥ç”¨æ¥æè¿°APIä¸­å¯ç”¨çš„æ•°æ®å’Œæ“ä½œï¼ŒåŒ…æ‹¬æ”¯æŒçš„æŸ¥è¯¢ã€å˜æ›´ã€è®¢é˜…ç­‰åŠŸèƒ½
* `GraphQL schema`ç”±ä¸€ç³»åˆ—çš„ç±»åž‹ç»„æˆï¼Œæ¯ç§ç±»åž‹éƒ½æœ‰ä¸€ä¸ªåç§°å’Œä¸€äº›å­—æ®µã€‚æ¯ä¸ªå­—æ®µéƒ½æœ‰ä¸€ä¸ªåç§°å’Œç±»åž‹ï¼Œå¹¶å¯èƒ½æœ‰ä¸€äº›é¢å¤–çš„é™åˆ¶ï¼Œæ¯”å¦‚æ˜¯å¦æ˜¯å¿…å¡«çš„æˆ–è€…æœ‰é»˜è®¤å€¼

### 9.3 resolvers [#](#t5393-resolvers)

* [resolvers](https://www.apollographql.com/docs/apollo-server/data/resolvers/)
* åœ¨GraphQLä¸­ï¼Œ `resolvers`æ˜¯è´Ÿè´£è§£æžæ¯ä¸ªå­—æ®µçš„å‡½æ•°ã€‚åœ¨Apollo Serverä¸­ï¼Œä½ å¯ä»¥ä½¿ç”¨resolverså¯¹è±¡æ¥å®šä¹‰è¿™äº›å‡½æ•°
* `resolvers`å¯¹è±¡æ˜¯ä¸€ä¸ªåŒ…å«äº†æ‰€æœ‰è§£æžå™¨å‡½æ•°çš„å¯¹è±¡ã€‚å®ƒçš„ç»“æž„ä¸Žä½ åœ¨schemaä¸­å®šä¹‰çš„ç±»åž‹çš„ç»“æž„æ˜¯ä¸€æ ·çš„
* é™¤äº†å®šä¹‰è§£æžå™¨å‡½æ•°ä»¥å¤–ï¼Œä½ è¿˜å¯ä»¥åœ¨resolverså¯¹è±¡ä¸­å®šä¹‰è‡ªå®šä¹‰æ“ä½œï¼Œä¾‹å¦‚æŸ¥è¯¢ã€å˜æ›´ã€è®¢é˜…ç­‰ã€‚è¿™äº›æ“ä½œçš„è§£æžå™¨å‡½æ•°ä¸Žå­—æ®µçš„è§£æžå™¨å‡½æ•°çš„å®šä¹‰æ–¹å¼æ˜¯ä¸€æ ·çš„ï¼Œåªæ˜¯å‡½æ•°åç§°ä¸åŒè€Œå·²

### 9.4 ApolloServerç¤ºä¾‹ [#](#t5494-apolloserverç¤ºä¾‹)

* `gql`å‡½æ•°æ˜¯ä¸€ä¸ª `template tag`ï¼Œä½ å¯ä»¥å°†å®ƒæ”¾åœ¨æ¨¡æ¿å­—ç¬¦ä¸²çš„å‰é¢ï¼Œç„¶åŽåœ¨æ¨¡æ¿å­—ç¬¦ä¸²ä¸­ç¼–å†™GraphQL schema languageçš„ä»£ç ,å¯ä»¥å®šä¹‰æŸ¥è¯¢å’Œå˜æ›´æ“ä½œ
* resolverså‡½æ•°å‚æ•°
  - objï¼šè¡¨ç¤ºå½“å‰æŸ¥è¯¢çš„çˆ¶å¯¹è±¡ã€‚ä¾‹å¦‚ï¼Œå¦‚æžœä½ åœ¨æŸ¥è¯¢"user"ç±»åž‹çš„å¯¹è±¡ï¼Œé‚£ä¹ˆobjå°±è¡¨ç¤ºå½“å‰æŸ¥è¯¢çš„"user"å¯¹è±¡
  - argsï¼šè¡¨ç¤ºå½“å‰æŸ¥è¯¢çš„å‚æ•°ã€‚ä¾‹å¦‚ï¼Œå¦‚æžœä½ åœ¨æŸ¥è¯¢å¸¦æœ‰å‚æ•°çš„å­—æ®µï¼Œé‚£ä¹ˆargså°±è¡¨ç¤ºè¿™äº›å‚æ•°
  - contextï¼šè¡¨ç¤ºå½“å‰çš„ä¸Šä¸‹æ–‡å¯¹è±¡ï¼Œå¯ä»¥åœ¨æ•´ä¸ªæŸ¥è¯¢ä¸­ä¼ é€’ç»™æ‰€æœ‰çš„resolver
  - infoï¼šè¡¨ç¤ºå½“å‰çš„æŸ¥è¯¢ä¿¡æ¯ï¼ŒåŒ…æ‹¬æŸ¥è¯¢å­—ç¬¦ä¸²ã€æŸ¥è¯¢æ“ä½œï¼ˆquery/mutationï¼‰ã€æŸ¥è¯¢å­—æ®µç­‰

```js
const { ApolloServer, gql } = require('apollo-server');
const typeDefs = gql`
  type Query {
    users: [User]
    user(id: ID): User
  }
  type Mutation {
    createUser(username: String, age: Int): User
    updateUser(id: ID, username: String, age: Int): Boolean
    deleteUser(id: ID): Boolean
  }
  type User {
    id: ID
    username: String
    age: Int
  }
`;
let users = [
    { id: "1", username: "zhangsan", age: 25 },
    { id: "2", username: "lisi", age: 30 },
];
const resolvers = {
    Query: {
        users: (obj, args, context, info) => {
            return users;
        },
        user: (obj, args, context, info) => {
            return users.find(user => user.id === args.id);
        }
    },
    Mutation: {
        createUser: (obj, args, context, info) => {
            const newUser = { id: users.length + 1, username: args.username, age: args.age };
            users.push(newUser);
            return newUser;
        },
        updateUser: (obj, args, context, info) => {
            const updatedUser = { id: args.id, username: args.username, age: args.age };
            users = users.map(user => {
                if (user.id === args.id) {
                    return updatedUser;
                }
                return user;
            });
            return true;
        },
        deleteUser: (obj, args, context, info) => {
            users = users.filter(user => user.id !== args.id);
            return true;
        },
    },
};
const server = new ApolloServer({ typeDefs, resolvers });
server.listen().then(({ url }) => {
    console.log(`Server ready at ${url}`);
});
```

```js
query {
    users {
        id
        username
        age
    }
}
query {
    user(id: "1") {
        id
        username
        age
    }
}
mutation {
    createUser(username: "wangwu", age: 35) {
        id
        username
        age
    }
}
mutation {
    updateUser(id: "1", username: "zhangsan2", age: 26)
}
mutation {
    deleteUser(id: "1")
}
```

### 9.5 Apollo Server Koa [#](#t5595-apollo-server-koa)

* Apollo Server Koa æ˜¯ä¸€ä¸ªåŸºäºŽ Koa çš„ä¸­é—´ä»¶ï¼Œå¯ä»¥å°† `GraphQL API` æ·»åŠ åˆ° Koa åº”ç”¨ç¨‹åºä¸­ã€‚å®ƒä½¿ç”¨ `Apollo Server` æ¥æ‰§è¡Œ `GraphQL` æœåŠ¡å™¨é€»è¾‘ï¼Œå¹¶å…è®¸ä½¿ç”¨ Koa çš„ä¼˜ç§€ç‰¹æ€§ï¼ˆå¦‚è·¯ç”±å’Œä¸­é—´ä»¶ï¼‰æ¥æž„å»ºåº”ç”¨ç¨‹åº

```js
const Koa = require('koa');
const { ApolloServer } = require('apollo-server-koa');

const typeDefs = `
  type Query {
    hello: String
  }
`;

const resolvers = {
    Query: {
        hello: () => 'Hello, world!',
    },
};

(async function () {
    const server = new ApolloServer({ typeDefs, resolvers });
    await server.start()
    const app = new Koa();
    server.applyMiddleware({ app });
    app.listen({ port: 4000 }, () =>
        console.log(`ðŸš€ Server ready at http://localhost:4000${server.graphqlPath}`)
    );
})()

```
