---
link: null
title: ç å³°æž¶æž„å¸ˆæˆé•¿è®¡åˆ’
description: null
keywords: null
author: null
date: null
publisher: ç å³°æž¶æž„å¸ˆæˆé•¿è®¡åˆ’
stats: paragraph=211 sentences=908, words=5739
---
## 1.å‡†å¤‡å·¥ä½œ [#](#t01å‡†å¤‡å·¥ä½œ)

### 1.1 monorepo [#](#t111-monorepo)

* monoRepoï¼š æ˜¯å°†æ‰€æœ‰çš„æ¨¡å—ç»Ÿä¸€çš„æ”¾åœ¨ä¸€ä¸ªä¸»å¹²åˆ†æ”¯ä¹‹ä¸­ç®¡ç†ã€‚
* multiRepoï¼š å°†é¡¹ç›®åˆ†åŒ–æˆä¸ºå¤šä¸ªæ¨¡å—ï¼Œå¹¶é’ˆå¯¹æ¯ä¸€ä¸ªæ¨¡å—å•ç‹¬çš„å¼€è¾Ÿä¸€ä¸ªRepoæ¥è¿›è¡Œç®¡ç†ã€‚

![](https://img.zhufengpeixun.com/1278ae09f1de08186e9e70fe3bb1c4d1)

### 1.2 Lerna [#](#t212-lerna)

* Lernaæ˜¯ä¸€ä¸ªç®¡ç†å¤šä¸ª npm æ¨¡å—çš„å·¥å…·,ä¼˜åŒ–ç»´æŠ¤å¤šåŒ…çš„å·¥ä½œæµï¼Œè§£å†³å¤šä¸ªåŒ…äº’ç›¸ä¾èµ–ï¼Œä¸”å‘å¸ƒéœ€è¦æ‰‹åŠ¨ç»´æŠ¤å¤šä¸ªåŒ…çš„é—®é¢˜

#### 1.2.1 å®‰è£… [#](#t3121-å®‰è£…)

```js
npm i lerna -g
```

#### 1.2.2 åˆå§‹åŒ– [#](#t4122-åˆå§‹åŒ–)

```js
lerna init
```

å‘½ä»¤ åŠŸèƒ½ lerna bootstrap å®‰è£…ä¾èµ– lerna clean åˆ é™¤å„ä¸ªåŒ…ä¸‹çš„node_modules lerna init åˆ›å»ºæ–°çš„lernaåº“ lerna list æŸ¥çœ‹æœ¬åœ°åŒ…åˆ—è¡¨ lerna changed æ˜¾ç¤ºè‡ªä¸Šæ¬¡release tagä»¥æ¥æœ‰ä¿®æ”¹çš„åŒ…ï¼Œ é€‰é¡¹é€š list lerna diff æ˜¾ç¤ºè‡ªä¸Šæ¬¡release tagä»¥æ¥æœ‰ä¿®æ”¹çš„åŒ…çš„å·®å¼‚ï¼Œ æ‰§è¡Œ git diff lerna exec åœ¨æ¯ä¸ªåŒ…ç›®å½•ä¸‹æ‰§è¡Œä»»æ„å‘½ä»¤ lerna run æ‰§è¡Œæ¯ä¸ªåŒ…package.jsonä¸­çš„è„šæœ¬å‘½ä»¤ lerna add æ·»åŠ ä¸€ä¸ªåŒ…çš„ç‰ˆæœ¬ä¸ºå„ä¸ªåŒ…çš„ä¾èµ– lerna import å¼•å…¥package lerna link é“¾æŽ¥äº’ç›¸å¼•ç”¨çš„åº“ lerna create æ–°å»ºpackage lerna publish å‘å¸ƒ

#### 1.2.3 æ–‡ä»¶ [#](#t5123-æ–‡ä»¶)

##### 1.2.3.1 package.json [#](#t61231-packagejson)

```json
{
  "name": "root",
  "private": true,
  "devDependencies": {
    "lerna": "^4.0.0"
  }
}
```

##### 1.2.3.2 lerna.json [#](#t71232-lernajson)

```json
{
  "packages": [
    "packages/*"
  ],
  "version": "0.0.0"
}
```

##### 1.2.3.3 .gitignore [#](#t81233-gitignore)

```yaml
node_modules
.DS_Store
design
*.log
packages/test
dist
temp
.vuerc
.version
.versions
.changelog
```

#### 1.2.4 yarn workspace [#](#t9124-yarn-workspace)

* yarn workspaceå…è®¸æˆ‘ä»¬ä½¿ç”¨ monorepo çš„å½¢å¼æ¥ç®¡ç†é¡¹ç›®
* åœ¨å®‰è£… node_modules çš„æ—¶å€™å®ƒä¸ä¼šå®‰è£…åˆ°æ¯ä¸ªå­é¡¹ç›®çš„ node_modules é‡Œé¢ï¼Œè€Œæ˜¯ç›´æŽ¥å®‰è£…åˆ°æ ¹ç›®å½•ä¸‹é¢ï¼Œè¿™æ ·æ¯ä¸ªå­é¡¹ç›®éƒ½å¯ä»¥è¯»å–åˆ°æ ¹ç›®å½•çš„ node_modules
* æ•´ä¸ªé¡¹ç›®åªæœ‰æ ¹ç›®å½•ä¸‹é¢ä¼šæœ‰ä¸€ä»½ yarn.lock æ–‡ä»¶ã€‚å­é¡¹ç›®ä¹Ÿä¼šè¢« link åˆ° node_modules é‡Œé¢ï¼Œè¿™æ ·å°±å…è®¸æˆ‘ä»¬å°±å¯ä»¥ç›´æŽ¥ç”¨ import å¯¼å…¥å¯¹åº”çš„é¡¹ç›®
* yarn.lockæ–‡ä»¶æ˜¯è‡ªåŠ¨ç”Ÿæˆçš„,ä¹Ÿå®Œå…¨Yarnæ¥å¤„ç†.yarn.locké”å®šä½ å®‰è£…çš„æ¯ä¸ªä¾èµ–é¡¹çš„ç‰ˆæœ¬ï¼Œè¿™å¯ä»¥ç¡®ä¿ä½ ä¸ä¼šæ„å¤–èŽ·å¾—ä¸è‰¯ä¾èµ–

###### 1.2.4.1 package.json [#](#t101241-packagejson)

package.json

```diff
{
  "name": "root",
  "private": true,
+  "workspaces": [
+    "packages/*"
+  ],
  "devDependencies": {
    "lerna": "^4.0.0"
  }
}
```

###### 1.2.4.2 lerna.json [#](#t111242-lernajson)

lerna.json

```diff
{
  "packages": [
    "packages/*"
  ],
  "version": "1.0.0",
+ "useWorkspaces": true,
+ "npmClient": "yarn"
}
```

###### 1.2.4.3 æ·»åŠ ä¾èµ– [#](#t121243-æ·»åŠ ä¾èµ–)

* [yarnpkg](https://classic.yarnpkg.com/en/docs/cli)
* [lerna](https://github.com/lerna/lerna#readme)

è®¾ç½®åŠ é€Ÿé•œåƒ

```js
yarn config set registry http://registry.npm.taobao.org
 npm config set registry https://registry.npm.taobao.org
```

ä½œç”¨ å‘½ä»¤ æŸ¥çœ‹å·¥ä½œç©ºé—´ä¿¡æ¯ yarn workspaces info ç»™æ ¹ç©ºé—´æ·»åŠ ä¾èµ– yarn add chalk cross-spawn fs-extra --ignore-workspace-root-check ç»™æŸä¸ªé¡¹ç›®æ·»åŠ ä¾èµ– yarn workspace create-react-app3 add commander åˆ é™¤æ‰€æœ‰çš„ node_modules lerna clean ç­‰äºŽ yarn workspaces run clean å®‰è£…å’Œlink yarn install ç­‰äºŽ lerna bootstrap --npm-client yarn --use-workspaces é‡æ–°èŽ·å–æ‰€æœ‰çš„ node_modules yarn install --force æŸ¥çœ‹ç¼“å­˜ç›®å½• yarn cache dir æ¸…é™¤æœ¬åœ°ç¼“å­˜ yarn cache clean

#### 1.2.5 åˆ›å»ºå­é¡¹ç›® [#](#t13125-åˆ›å»ºå­é¡¹ç›®)

```js
lerna create zhang-cli
lerna create  zhang-cli-shared-utils
```

##### 1.2.5.1 zhang-cli [#](#t141251-zhang-cli)

###### 1.2.5.1.1 package.json [#](#t1512511-packagejson)

packages\zhang-cli\bin\vue.js

```json
{
  "name": "zhang-cli",
  "version": "0.0.0",
  "description": "zhang-cli",
  "author": "zhangrenyang ",
  "homepage": "",
  "license": "MIT",
  "main": "bin/vue.js"
}
```

###### 1.2.5.1.2 vue.js [#](#t1612512-vuejs)

packages\zhang-cli\bin\vue.js

```js

console.log('vue cli');
```

###### 1.2.5.2.1 package.json [#](#t1812521-packagejson)

packages\zhang-cli-shared-utils\package.json

```json
{
  "name": "zhang-cli-shared-utils",
  "version": "0.0.0",
  "description": "zhang-cli-shared-utils",
  "author": "zhangrenyang ",
  "homepage": "",
  "license": "MIT",
  "main": "index.js"
}
```

###### 1.2.5.2.2 index.js [#](#t1912522-indexjs)

packages\zhang-cli-shared-utils\index.js

#### 1.2.6 åˆ›å»ºè½¯é“¾æŽ¥ [#](#t20126-åˆ›å»ºè½¯é“¾æŽ¥)

```sh
yarn
cd packages/zhang-cli
npm link
npm root -g
zhang-cli
```

#### 1.2.7 createå‘½ä»¤ [#](#t21127-createå‘½ä»¤)

```diff
{
  "name": "root",
  "private": true,
  "workspaces": [
    "packages/*"
  ],
  "devDependencies": {
    "lerna": "^4.0.0"
  },
  "scripts": {
+   "create": "node ./packages/zhang-cli/bin/vue.js create hello1"
  }
}
```

#### 1.2.8 è°ƒè¯•å‘½ä»¤ [#](#t22128-è°ƒè¯•å‘½ä»¤)

.vscode\launch.json

```json
{
    "version": "0.2.0",
    "configurations": [
        {
            "type": "node",
            "request": "launch",
            "name": "vue-cli",
            "cwd":"${workspaceFolder}",
            "runtimeExecutable": "npm",
            "runtimeArgs": [
                "run",
                "create"
            ],
            "port":9229,
            "autoAttachChildProcesses": true,
            "stopOnEntry": true,
            "skipFiles": [
                "/**"
            ]
        }
    ]
}
```

### 1.3 å®‰è£…ä¾èµ– [#](#t2313-å®‰è£…ä¾èµ–)

```js
npm config set registry=https://registry.npm.taobao.org
yarn config set registry https://registry.npm.taobao.org

cd packages/zhang-cli-shared-utils
yarn workspace zhang-cli-shared-utils add  chalk execa

cd packages/zhang-cli
yarn workspace zhang-cli add  zhang-cli-shared-utils commander inquirer execa chalk ejs globby  lodash.clonedeep fs-extra ora isbinaryfile
```

### 1.4 lerna vs yarn [#](#t2414-lerna-vs-yarn)

* ä¸¤è€…å¾ˆå¤šåŠŸèƒ½æ˜¯ç­‰ä»·çš„
* `yarn`ç”¨æ¥å¤„ç†ä¾èµ–ï¼Œ `lerna`ç”¨äºŽåˆå§‹åŒ–å’Œå‘å¸ƒ

### 1.4 commander.js [#](#t2514-commanderjs)

* [commander](https://github.com/tj/commander.js/blob/master/Readme_zh-CN.md) æ˜¯ä¸€æ¬¾å¼ºå¤§çš„å‘½ä»¤è¡Œæ¡†æž¶ï¼Œæä¾›äº†ç”¨æˆ·å‘½ä»¤è¡Œè¾“å…¥å’Œå‚æ•°è§£æžåŠŸèƒ½

```js

const program = require('commander');
program
    .version(`zhang-cli 0.0.0}`)
    .usage(' [options]')

program
    .command('create ')
    .description('create a new project powered by vue-cli-service')
    .action((name) => {
        console.log(name);
    })

program.parse(process.argv)
```

```js
node 1.2.commander.js
Usage: 1.2.commander  [options]

Options:
  -V, --version      output the version number
  -h, --help         display help for command

Commands:
  create   create a new project powered by vue-cli-service
  help [command]     display help for command

node 1.2.commander.js create hello
```

### 1.5 Inquirer.js [#](#t2615-inquirerjs)

* [Inquirer](https://github.com/SBoudrias/Inquirer.js)æ˜¯ä¸€ä¸ªäº¤äº’å¼å‘½ä»¤è¡Œå·¥å…·

```js
const inquirer = require('inquirer')
const isManualMode = answers => answers.preset === '__manual__';
let defaultPreset = {
    useConfigFiles: false,
    cssPreprocessor: undefined,
    plugins: {
        '@vue/cli-plugin-babel': {},
        '@vue/cli-plugin-eslint': {
            config: 'base',
            lintOn: ['save']
        }
    }
}
let presets = {
    'default': Object.assign({ vueVersion: '2' }, defaultPreset),
    '__default_vue_3__': Object.assign({ vueVersion: '3' }, defaultPreset)
}
const presetChoices = Object.entries(presets).map(([name, preset]) => {
    let displayName = name
    if (name === 'default') {
        displayName = 'Default'
    } else if (name === '__default_vue_3__') {
        displayName = 'Default (Vue 3)'
    }
    return {
        name: `${displayName}`,
        value: name
    }
})
const presetPrompt = {
    name: 'preset',
    type: 'list',
    message: `Please pick a preset:`,
    choices: [
        ...presetChoices,
        {
            name: 'Manually select features',
            value: '__manual__'
        }
    ]
}
let features = [
    'vueVersion',
    'babel',
    'typescript',
    'pwa',
    'router',
    'vuex',
    'cssPreprocessors',
    'linter',
    'unit',
    'e2e'
];
const featurePrompt = {
    name: 'features',
    when: isManualMode,
    type: 'checkbox',
    message: 'Check the features needed for your project:',
    choices: features,
    pageSize: 10
}
const prompts = [
    presetPrompt,
    featurePrompt
]

;(async function(){
 let result = await inquirer.prompt(prompts);
 console.log(result);
})();
```

### 1.6 execa [#](#t2716-execa)

* execa æ˜¯å¯ä»¥è°ƒç”¨ shell å’Œæœ¬åœ°å¤–éƒ¨ç¨‹åº
* å®ƒä¼šå¯åŠ¨å­è¿›ç¨‹æ‰§è¡Œï¼Œæ˜¯å¯¹ `child_process.exec`çš„å°è£…

```js
const execa = require('execa');

(async () => {
    const {stdout} = await execa('echo', ['hello']);
    console.log(stdout);
})();
```

### 1.7 chalk [#](#t2817-chalk)

* [chalk](https://github.com/chalk/chalk)å¯ä»¥ä¿®æ”¹æŽ§åˆ¶å°å­—ç¬¦ä¸²çš„æ ·å¼ï¼ŒåŒ…æ‹¬å­—ä½“æ ·å¼ã€é¢œè‰²ä»¥åŠèƒŒæ™¯é¢œè‰²ç­‰

```js
const chalk = require('chalk');
console.log(chalk.blue('Hello world!'));
```

### 1.8 ejs [#](#t2918-ejs)

* [ejs](https://ejs.bootcss.com)æ˜¯é«˜æ•ˆçš„åµŒå…¥å¼ JavaScript æ¨¡æ¿å¼•æ“Ž
* [slash](https://www.npmjs.com/package/slash)å°†Windowsåæ–œæ è·¯å¾„è½¬æ¢ä¸ºæ–œæ è·¯å¾„ï¼Œå¦‚ `foo\\bar`âž” `foo/bar`
* [globby](https://www.npmjs.com/package/globby)æ˜¯ç”¨äºŽæ¨¡å¼åŒ¹é…ç›®å½•æ–‡ä»¶çš„

#### 1.8.1 main.js [#](#t30181-mainjs)

template\main.js

```js
if (rootOptions.vueVersion === '3') { _%>
  import { createApp } from 'vue'
  import App from './App.vue'
  createApp(App).mount('#app')
else { _%>
  import Vue from 'vue'
  import App from './App.vue'
  Vue.config.productionTip = false
  new Vue({
    render: h => h(App),
  }).$mount('#app')

```

#### 1.8.2 components [#](#t31182-components)

doc\template\components

```js

  HelloWorld

export default {
  name: 'HelloWorld'
}

```

#### 1.8.3 ejs.js [#](#t32183-ejsjs)

doc\1.7.ejs.js

```js
const path = require('path');
const fs = require('fs');
const ejs = require('ejs');
const globby = require('globby')
const slash = require('slash')
let source = path.join(__dirname, 'template');
;(async function () {
    const _files = await globby(['**/*'], { cwd: source })
    let files = {};
    for (const rawPath of _files) {
        const sourcePath = slash(path.resolve(source, rawPath))
        const template = fs.readFileSync(sourcePath, 'utf8')
        const content = ejs.render(template, {
            rootOptions: { vueVersion: '2' }
        })
        files[sourcePath] = content;
    }
    console.log(files);
})();

```

### 1.9 isbinaryfile [#](#t3319-isbinaryfile)

* [isbinaryfile](https://www.npmjs.com/package/isbinaryfile)å¯ä»¥æ£€æµ‹ä¸€ä¸ªæ–‡ä»¶æ˜¯å¦æ˜¯äºŒè¿›åˆ¶æ–‡ä»¶

```js
const path = require('path');
const { isBinaryFileSync } = require('isbinaryfile');
let logo = path.join(__dirname,'template/assets/logo.png');
let isBinary = isBinaryFileSync(logo);
console.log(isBinary);
let main = path.join(__dirname,'template/main.js');
isBinary = isBinaryFileSync(main);
console.log(isBinary);
```

### 1.10 ora [#](#t34110-ora)

* [ora](https://www.npmjs.com/package/ora)ä¸»è¦ç”¨æ¥å®žçŽ°node.jså‘½ä»¤è¡ŒçŽ¯å¢ƒçš„loadingæ•ˆæžœï¼Œå’Œæ˜¾ç¤ºå„ç§çŠ¶æ€çš„å›¾æ ‡ç­‰

```js
const ora = require('ora')
const spinner = ora()

exports.logWithSpinner = (msg) => {
    spinner.text = msg
    spinner.start();
}

exports.stopSpinner = () => {
    spinner.stop();
}

exports.logWithSpinner('npm install');
setTimeout(()=>{
    exports.stopSpinner();
},3000);
```

## 2.æ ¸å¿ƒæ¦‚å¿µ [#](#t352æ ¸å¿ƒæ¦‚å¿µ)

* [@vue/cli](https://cli.vuejs.org/zh/guide/)æ˜¯ä¸€ä¸ªåŸºäºŽ Vue.js è¿›è¡Œå¿«é€Ÿå¼€å‘çš„å®Œæ•´ç³»ç»Ÿ

### 2.1 æ’ä»¶ [#](#t3621-æ’ä»¶)

* [æ’ä»¶](https://cli.vuejs.org/zh/guide/plugins-and-presets.html)
* Vue CLI ä½¿ç”¨äº†ä¸€å¥—åŸºäºŽæ’ä»¶çš„æž¶æž„ã€‚å¦‚æžœä½ æŸ¥é˜…ä¸€ä¸ªæ–°åˆ›å»ºé¡¹ç›®çš„ package.jsonï¼Œå°±ä¼šå‘çŽ°ä¾èµ–éƒ½æ˜¯ä»¥ @vue/cli-plugin- å¼€å¤´çš„ã€‚æ’ä»¶å¯ä»¥ä¿®æ”¹ webpack çš„å†…éƒ¨é…ç½®ï¼Œä¹Ÿå¯ä»¥å‘ `vue-cli-service` æ³¨å…¥å‘½ä»¤ã€‚åœ¨é¡¹ç›®åˆ›å»ºçš„è¿‡ç¨‹ä¸­ï¼Œç»å¤§éƒ¨åˆ†åˆ—å‡ºçš„ç‰¹æ€§éƒ½æ˜¯é€šè¿‡æ’ä»¶æ¥å®žçŽ°çš„
* æ¯ä¸ª CLI æ’ä»¶éƒ½ä¼šåŒ…å«ä¸€ä¸ª (ç”¨æ¥åˆ›å»ºæ–‡ä»¶çš„) ç”Ÿæˆå™¨å’Œä¸€ä¸ª (ç”¨æ¥è°ƒæ•´ webpack æ ¸å¿ƒé…ç½®å’Œæ³¨å…¥å‘½ä»¤çš„) è¿è¡Œæ—¶æ’ä»¶
* å®˜æ–¹æ’ä»¶æ ¼å¼ `@vue/cli-plugin-eslint`,ç¤¾åŒºæ’ä»¶ `vue-cli-plugin-apollo`,æŒ‡å®šçš„ scope ä½¿ç”¨ç¬¬ä¸‰æ–¹æ’ä»¶ `@foo/vue-cli-plugin-bar`

### 2.3 é¢„è®¾ [#](#t3723-é¢„è®¾)

* ä¸€ä¸ª Vue CLI preset æ˜¯ä¸€ä¸ªåŒ…å«åˆ›å»ºæ–°é¡¹ç›®æ‰€éœ€é¢„å®šä¹‰é€‰é¡¹å’Œæ’ä»¶çš„ JSON å¯¹è±¡ï¼Œè®©ç”¨æˆ·æ— éœ€åœ¨å‘½ä»¤æç¤ºä¸­é€‰æ‹©å®ƒä»¬
* åœ¨ vue create è¿‡ç¨‹ä¸­ä¿å­˜çš„ preset ä¼šè¢«æ”¾åœ¨ä½ çš„ home ç›®å½•ä¸‹çš„ä¸€ä¸ªé…ç½®æ–‡ä»¶ä¸­ (~/.vuerc)ã€‚ä½ å¯ä»¥é€šè¿‡ç›´æŽ¥ç¼–è¾‘è¿™ä¸ªæ–‡ä»¶æ¥è°ƒæ•´ã€æ·»åŠ ã€åˆ é™¤ä¿å­˜å¥½çš„ preset
* Preset çš„æ•°æ®ä¼šè¢«æ’ä»¶ç”Ÿæˆå™¨ç”¨æ¥ç”Ÿæˆç›¸åº”çš„é¡¹ç›®æ–‡ä»¶

```js
exports.defaultPreset = {
  useConfigFiles: false,
  cssPreprocessor: undefined,
  plugins: {
    '@vue/cli-plugin-babel': {},
    '@vue/cli-plugin-eslint': {
      config: 'base',
      lintOn: ['save']
    }
  }
}
```

### 2.4 ç‰¹æ€§ [#](#t3824-ç‰¹æ€§)

* åœ¨æ‰‹å·¥æ¨¡å¼ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªç”±é€‰æ‹©ä»¥ä¸‹ç‰¹æ€§
  - vueVersion
  - babel
  - typescript
  - pwa
  - router
  - vuex
  - cssPreprocessors
  - linter
  - unit
  - e2e
* é€‰æ‹©ä¸åŒçš„ç‰¹æ€§ä¼šæ·»åŠ ä¸åŒçš„æ’ä»¶ï¼Œä¸åŒçš„æ’ä»¶ä¼šç”Ÿæˆä¸åŒçš„æ–‡ä»¶å’Œä¿®æ”¹é¡¹ç›®çš„é…ç½®

### 2.5 create [#](#t3925-create)

![](https://img.zhufengpeixun.com/589f4d15c7d8574f847e57ef0e0d2191)

## 3.å‚æ•°è§£æž [#](#t403å‚æ•°è§£æž)

### 3.1 vue.js [#](#t4131-vuejs)

packages\zhang-cli\bin\vue.js

```js

const program = require('commander');
program
    .version(`@vue/zhang-cli ${require('../package').version}`)
    .usage(' [options]')

program
    .command('create ')
    .description('create a new project powered by vue-cli-service')
    .action((name) => {
        require('../lib/create')(name)
    })

program.parse(process.argv)
```

### 3.2 create.js [#](#t4232-createjs)

packages\zhang-\lib\create.js

```js
const path = require('path');
async function create(projectName, options) {
  const cwd = process.cwd();
  const name = projectName;
  const targetDir = path.resolve(cwd, projectName);
  console.log(name);
  console.log(targetDir);
}

module.exports = (...args) => {
  return create(...args).catch(err => {
    console.log(err);
  })
}
```

## 4.èŽ·å–é¢„è®¾ [#](#t434èŽ·å–é¢„è®¾)

### 4.1 create.js [#](#t4441-createjs)

packages\zhang-cli\lib\create.js

```diff
const path = require('path');
+const Creator = require('./Creator');
+const { getPromptModules } = require('./util/createTools')
async function create(projectName) {
  const cwd = process.cwd();
  const name = projectName;
  const targetDir = path.resolve(cwd, projectName);
+ const promptModules = getPromptModules();
+ const creator = new Creator(name, targetDir,promptModules);
+ await creator.create();
}

module.exports = (...args) => {
  return create(...args).catch(err => {
    console.log(err);
  })
}
```

### 4.2 options.js [#](#t4542-optionsjs)

packages\zhang-cli\lib\options.js

```js
exports.defaultPreset = {
  useConfigFiles: false,
  cssPreprocessor: undefined,
  plugins: {
    '@vue/cli-plugin-babel': {},
    '@vue/cli-plugin-eslint': {
      config: 'base',
      lintOn: ['save']
    }
  }
}

exports.defaults = {
  presets: {
    'default': Object.assign({ vueVersion: '2' }, exports.defaultPreset),
    '__default_vue_3__': Object.assign({ vueVersion: '3' }, exports.defaultPreset)
  }
}
```

### 4.3 PromptModuleAPI.js [#](#t4643-promptmoduleapijs)

packages\zhang-cli\lib\PromptModuleAPI.js

```js
class PromptModuleAPI {
    constructor(creator) {
        this.creator = creator
    }

    injectFeature(feature) {
        this.creator.featurePrompt.choices.push(feature)
    }

    injectPrompt(prompt) {
        this.creator.injectedPrompts.push(prompt)
    }

    onPromptComplete(cb) {
        this.creator.promptCompleteCbs.push(cb)
    }
}
module.exports = PromptModuleAPI;

```

### 4.4 createTools.js [#](#t4744-createtoolsjs)

packages\zhang-cli\lib\util\createTools.js

```js
exports.getPromptModules = () => {
    return [
        'vueVersion'
    ].map(file => require(`../promptModules/${file}`))
}

```

### 4.5 vueVersion.js [#](#t4845-vueversionjs)

packages\zhang-cli\lib\promptModules\vueVersion.js

```js
module.exports = cli => {

  cli.injectFeature({
    name: 'Choose Vue version',
    value: 'vueVersion',
    description: 'Choose a version of Vue.js that you want to start the project with',
    checked: true
  })

  cli.injectPrompt({
    name: 'vueVersion',
    when: answers => answers.features.includes('vueVersion'),
    message: 'Choose a version of Vue.js that you want to start the project with',
    type: 'list',
    choices: [
      {
        name: '2.x',
        value: '2'
      },
      {
        name: '3.x',
        value: '3'
      }
    ],
    default: '2'
  })

  cli.onPromptComplete((answers, options) => {
    if (answers.vueVersion) {
      options.vueVersion = answers.vueVersion
    }
  })
}

```

### 4.6 Creator.js [#](#t4946-creatorjs)

packages\zhang-cli\lib\Creator.js

```js
const { defaults } = require('./options');
const PromptModuleAPI = require('./PromptModuleAPI');
const inquirer = require('inquirer')
const isManualMode = answers => answers.preset === '__manual__'
class Creator {
    constructor(name, context, promptModules) {
        this.name = name;
        this.context = process.env.VUE_CLI_CONTEXT = context;
        const { presetPrompt, featurePrompt } = this.resolveIntroPrompts();
        this.presetPrompt = presetPrompt;
        this.featurePrompt = featurePrompt;
        this.injectedPrompts = []
        this.promptCompleteCbs = []
        const promptAPI = new PromptModuleAPI(this)
        promptModules.forEach(m => m(promptAPI))
    }
    async create() {
        let preset = await this.promptAndResolvePreset()
        console.log('preset', preset);
    }
    resolveFinalPrompts() {
        this.injectedPrompts.forEach(prompt => {
            const originalWhen = prompt.when || (() => true)
            prompt.when = answers => {
                return isManualMode(answers) && originalWhen(answers)
            }
        })
        const prompts = [
            this.presetPrompt,
            this.featurePrompt,
            ...this.injectedPrompts,
        ]
        return prompts
    }
    async promptAndResolvePreset(answers = null) {
        if (!answers) {
            answers = await inquirer.prompt(this.resolveFinalPrompts())
        }
        let preset;
        if (answers.preset && answers.preset !== '__manual__') {
            preset = await this.resolvePreset(answers.preset)
        } else {
            preset = {
                plugins: {}
            }
            answers.features = answers.features || []
            this.promptCompleteCbs.forEach(cb => cb(answers, preset))
        }
        return preset
    }
    async resolvePreset (name) {
        const savedPresets = this.getPresets()
        return savedPresets[name];
    }
    getPresets() {
        return Object.assign({}, defaults.presets)
    }
    resolveIntroPrompts() {
        const presets = this.getPresets()
        const presetChoices = Object.entries(presets).map(([name]) => {
            let displayName = name
            if (name === 'default') {
                displayName = 'Default'
            } else if (name === '__default_vue_3__') {
                displayName = 'Default (Vue 3)'
            }
            return {
                name: `${displayName}`,
                value: name
            }
        })
        const presetPrompt = {
            name: 'preset',
            type: 'list',
            message: `Please pick a preset:`,
            choices: [
                ...presetChoices,
                {
                    name: 'Manually select features',
                    value: '__manual__'
                }
            ]
        }
        const featurePrompt = {
            name: 'features',
            when: isManualMode,
            type: 'checkbox',
            message: 'Check the features needed for your project:',
            choices: [],
            pageSize: 10
        }
        return {
            presetPrompt,
            featurePrompt
        }
    }
}
module.exports = Creator;
```

## 5.å†™å…¥package.json [#](#t505å†™å…¥packagejson)

packages\zhang-cli-shared-utils\index.js

```js
exports.chalk = require('chalk')
```

### 5.2 Creator.js [#](#t5252-creatorjs)

packages\zhang-cli\lib\Creator.js

```diff
const { defaults } = require('./options');
const PromptModuleAPI = require('./PromptModuleAPI');
const inquirer = require('inquirer')
+const cloneDeep = require('lodash.clonedeep')
+const writeFileTree = require('./util/writeFileTree')
+const { chalk } = require('zhang-cli-shared-utils')
const isManualMode = answers => answers.preset
class Creator {
    constructor(name, context, promptModules) {
        this.name = name;
        this.context = process.env.VUE_CLI_CONTEXT = context;
        const { presetPrompt, featurePrompt } = this.resolveIntroPrompts();
        this.presetPrompt = presetPrompt;
        this.featurePrompt = featurePrompt;
        this.injectedPrompts = []
        this.promptCompleteCbs = []
        const promptAPI = new PromptModuleAPI(this)
        promptModules.forEach(m => m(promptAPI))
    }
    async create() {
+       const {name,context} = this;
        let preset = await this.promptAndResolvePreset()
        console.log('preset', preset);
+       preset = cloneDeep(preset);
+       preset.plugins['@vue/cli-service'] = Object.assign({projectName: name}, preset);
+       console.log(`âœ¨  Creating project in ${chalk.yellow(context)}.`)
+       const pkg = {
+           name,
+           version: '0.1.0',
+           private: true,
+           devDependencies: {}
+       }
+       const deps = Object.keys(preset.plugins)
+       deps.forEach(dep => {
+           pkg.devDependencies[dep] = 'latest';
+       })
+       await writeFileTree(context, {
+           'package.json': JSON.stringify(pkg, null, 2)
+       })
    }
    resolveFinalPrompts() {
        this.injectedPrompts.forEach(prompt => {
            const originalWhen = prompt.when || (() => true)
            prompt.when = answers => {
                return isManualMode(answers) && originalWhen(answers)
            }
        })
        const prompts = [
            this.presetPrompt,
            this.featurePrompt,
            ...this.injectedPrompts,
        ]
        return prompts
    }
    async promptAndResolvePreset(answers = null) {
        if (!answers) {
            answers = await inquirer.prompt(this.resolveFinalPrompts())
        }
        let preset;
        if (answers.preset && answers.preset !== '__manual__') {
            preset = await this.resolvePreset(answers.preset)
        } else {
            preset = {
                plugins: {}
            }
            answers.features = answers.features || []
            this.promptCompleteCbs.forEach(cb => cb(answers, preset))
        }
        return preset
    }
    async resolvePreset (name) {
        const savedPresets = this.getPresets()
        return savedPresets[name];
    }
    getPresets() {
        return Object.assign({}, defaults.presets)
    }
    resolveIntroPrompts() {
        const presets = this.getPresets()
        const presetChoices = Object.entries(presets).map(([name]) => {
            let displayName = name
            if (name
                displayName = 'Default'
            } else if (name
                displayName = 'Default (Vue 3)'
            }
            return {
                name: `${displayName}`,
                value: name
            }
        })
        const presetPrompt = {
            name: 'preset',
            type: 'list',
            message: `Please pick a preset:`,
            choices: [
                ...presetChoices,
                {
                    name: 'Manually select features',
                    value: '__manual__'
                }
            ]
        }
        const featurePrompt = {
            name: 'features',
            when: isManualMode,
            type: 'checkbox',
            message: 'Check the features needed for your project:',
            choices: [],
            pageSize: 10
        }
        return {
            presetPrompt,
            featurePrompt
        }
    }
}

module.exports = Creator;
```

### 5.3 writeFileTree.js [#](#t5353-writefiletreejs)

packages\zhang-cli\lib\util\writeFileTree.js

```js
const fs = require('fs-extra')
const path = require('path')
module.exports = async function writeFileTree(dir, files) {
  Object.keys(files).forEach((name) => {
    const filePath = path.join(dir, name)
    fs.ensureDirSync(path.dirname(filePath))
    fs.writeFileSync(filePath, files[name])
  })
}
```

## 6.å®‰è£…ä¾èµ– [#](#t546å®‰è£…ä¾èµ–)

### 6.1 Creator.js [#](#t5561-creatorjs)

packages\zhang-cli\lib\Creator.js

```diff
const { defaults } = require('./options');
const PromptModuleAPI = require('./PromptModuleAPI');
const inquirer = require('inquirer')
const cloneDeep = require('lodash.clonedeep')
const writeFileTree = require('./util/writeFileTree')
+const { chalk, execa } = require('zhang-cli-shared-utils')
const isManualMode = answers => answers.preset
class Creator {
    constructor(name, context, promptModules) {
        this.name = name;
        this.context = process.env.VUE_CLI_CONTEXT = context;
        const { presetPrompt, featurePrompt } = this.resolveIntroPrompts();
        this.presetPrompt = presetPrompt;
        this.featurePrompt = featurePrompt;
        this.injectedPrompts = []
        this.promptCompleteCbs = []
+       this.run = this.run.bind(this)//è¿è¡Œå‡½æ•°
        const promptAPI = new PromptModuleAPI(this)
        promptModules.forEach(m => m(promptAPI))
    }
+   run(command, args) {
+       return execa(command, args, { cwd: this.context })
+   }
    async create() {
+       const {name,context,run} = this;
        let preset = await this.promptAndResolvePreset()
        console.log('preset', preset);
        preset = cloneDeep(preset);
        preset.plugins['@vue/cli-service'] = Object.assign({projectName: name}, preset);
        console.log(`âœ¨  Creating project in ${chalk.yellow(context)}.`)
        const pkg = {
            name,
            version: '0.1.0',
            private: true,
            devDependencies: {}
        }
        const deps = Object.keys(preset.plugins)
        deps.forEach(dep => {
            pkg.devDependencies[dep] = 'latest';
        })
        await writeFileTree(context, {
            'package.json': JSON.stringify(pkg, null, 2)
        })
+       console.log(`ðŸ—ƒ  Initializing git repository...`)
+       await run('git init');
+       console.log(`âš™\u{fe0f} Installing CLI plugins. This might take a while...`)
+       await run('npm install');
    }
    resolveFinalPrompts() {
        this.injectedPrompts.forEach(prompt => {
            const originalWhen = prompt.when || (() => true)
            prompt.when = answers => {
                return isManualMode(answers) && originalWhen(answers)
            }
        })
        const prompts = [
            this.presetPrompt,
            this.featurePrompt,
            ...this.injectedPrompts,
        ]
        return prompts
    }
    async promptAndResolvePreset(answers = null) {
        if (!answers) {
            answers = await inquirer.prompt(this.resolveFinalPrompts())
        }
        let preset;
        if (answers.preset && answers.preset !== '__manual__') {
            preset = await this.resolvePreset(answers.preset)
        } else {
            preset = {
                plugins: {}
            }
            answers.features = answers.features || []
            this.promptCompleteCbs.forEach(cb => cb(answers, preset))
        }
        return preset
    }
    async resolvePreset (name) {
        const savedPresets = this.getPresets()
        return savedPresets[name];
    }
    getPresets() {
        return Object.assign({}, defaults.presets)
    }
    resolveIntroPrompts() {
        const presets = this.getPresets()
        const presetChoices = Object.entries(presets).map(([name]) => {
            let displayName = name
            if (name
                displayName = 'Default'
            } else if (name
                displayName = 'Default (Vue 3)'
            }
            return {
                name: `${displayName}`,
                value: name
            }
        })
        const presetPrompt = {
            name: 'preset',
            type: 'list',
            message: `Please pick a preset:`,
            choices: [
                ...presetChoices,
                {
                    name: 'Manually select features',
                    value: '__manual__'
                }
            ]
        }
        const featurePrompt = {
            name: 'features',
            when: isManualMode,
            type: 'checkbox',
            message: 'Check the features needed for your project:',
            choices: [],
            pageSize: 10
        }
        return {
            presetPrompt,
            featurePrompt
        }
    }
}

module.exports = Creator;
```

## 7.å®žçŽ°æ’ä»¶æœºåˆ¶ [#](#t567å®žçŽ°æ’ä»¶æœºåˆ¶)

![](https://img.zhufengpeixun.com/4a36deaf32188b9303b71a0f2936c043)

### 7.1 Creator.js [#](#t5771-creatorjs)

packages\zhang-cli\lib\Creator.js

```diff
const { defaults } = require('./options');
const PromptModuleAPI = require('./PromptModuleAPI');
const inquirer = require('inquirer')
const cloneDeep = require('lodash.clonedeep')
const writeFileTree = require('./util/writeFileTree')
+const { chalk, execa,loadModule } = require('zhang-cli-shared-utils')
+const Generator = require('./Generator')
const isManualMode = answers => answers.preset
class Creator {
    constructor(name, context, promptModules) {
        this.name = name;
        this.context = process.env.VUE_CLI_CONTEXT = context;
        const { presetPrompt, featurePrompt } = this.resolveIntroPrompts();
        this.presetPrompt = presetPrompt;
        this.featurePrompt = featurePrompt;
        this.injectedPrompts = []
        this.promptCompleteCbs = []
        this.run = this.run.bind(this)//è¿è¡Œå‡½æ•°
        const promptAPI = new PromptModuleAPI(this)
        promptModules.forEach(m => m(promptAPI))
    }
    run(command, args) {
        return execa(command, args, { cwd: this.context })
    }
    async create() {
        const {name,context,run} = this;
        let preset = await this.promptAndResolvePreset()
        console.log('preset', preset);
        preset = cloneDeep(preset);
        preset.plugins['@vue/cli-service'] = Object.assign({projectName: name}, preset);
        console.log(`âœ¨  Creating project in ${chalk.yellow(context)}.`)
        const pkg = {
            name,
            version: '0.1.0',
            private: true,
            devDependencies: {}
        }
        const deps = Object.keys(preset.plugins)
        deps.forEach(dep => {
            pkg.devDependencies[dep] = 'latest';
        })
        await writeFileTree(context, {
            'package.json': JSON.stringify(pkg, null, 2)
        })
        console.log(`ðŸ—ƒ  Initializing git repository...`)
        await run('git init');
        console.log(`âš™\u{fe0f} Installing CLI plugins. This might take a while...`)
        await run('npm install');
+       console.log(`ðŸš€  Invoking generators...`)
+       const plugins = await this.resolvePlugins(preset.plugins)
+       const generator = new Generator(context, {pkg,plugins})
+       await generator.generate();
    }
+   async resolvePlugins(rawPlugins) {
+       const plugins = []
+       for (const id of Object.keys(rawPlugins)) {
+           try{
+               const apply = loadModule(`${id}/generator`, this.context) || (() => {})
+               let options = rawPlugins[id] || {}
+               plugins.push({ id, apply, options })
+           }catch(error){
+               console.log(error);
+           }
+       }
+       return plugins
+   }
    resolveFinalPrompts() {
        this.injectedPrompts.forEach(prompt => {
            const originalWhen = prompt.when || (() => true)
            prompt.when = answers => {
                return isManualMode(answers) && originalWhen(answers)
            }
        })
        const prompts = [
            this.presetPrompt,
            this.featurePrompt,
            ...this.injectedPrompts,
        ]
        return prompts
    }
    async promptAndResolvePreset(answers = null) {
        if (!answers) {
            answers = await inquirer.prompt(this.resolveFinalPrompts())
        }
        let preset;
        if (answers.preset && answers.preset !== '__manual__') {
            preset = await this.resolvePreset(answers.preset)
        } else {
            preset = {
                plugins: {}
            }
            answers.features = answers.features || []
            this.promptCompleteCbs.forEach(cb => cb(answers, preset))
        }
        return preset
    }
    async resolvePreset (name) {
        const savedPresets = this.getPresets()
        return savedPresets[name];
    }
    getPresets() {
        return Object.assign({}, defaults.presets)
    }
    resolveIntroPrompts() {
        const presets = this.getPresets()
        const presetChoices = Object.entries(presets).map(([name]) => {
            let displayName = name
            if (name
                displayName = 'Default'
            } else if (name
                displayName = 'Default (Vue 3)'
            }
            return {
                name: `${displayName}`,
                value: name
            }
        })
        const presetPrompt = {
            name: 'preset',
            type: 'list',
            message: `Please pick a preset:`,
            choices: [
                ...presetChoices,
                {
                    name: 'Manually select features',
                    value: '__manual__'
                }
            ]
        }
        const featurePrompt = {
            name: 'features',
            when: isManualMode,
            type: 'checkbox',
            message: 'Check the features needed for your project:',
            choices: [],
            pageSize: 10
        }
        return {
            presetPrompt,
            featurePrompt
        }
    }
}
module.exports = Creator;
```

packages\zhang-cli-shared-utils\index.js

```diff
+['pluginResolution','module'].forEach(m => {
+    Object.assign(exports, require(`./lib/${m}`))
+})
exports.chalk = require('chalk')
exports.execa = require('execa')
```

### 7.3 module.js [#](#t5973-modulejs)

packages\zhang-cli-shared-utils\lib\module.js

```js
const Module = require('module')
const path = require('path')

exports.loadModule = function (request, context) {
    return Module.createRequire(path.resolve(context, 'package.json'))(request)
}
```

### 7.4 pluginResolution.js [#](#t6074-pluginresolutionjs)

packages\zhang-cli-shared-utils\lib\pluginResolution.js

```js
const pluginRE = /^@vue\/cli-plugin-/
exports.toShortPluginId = id => id.replace(pluginRE, '');
exports.isPlugin = id => pluginRE.test(id)
exports.matchesPluginId = (input, full) => {
    return full === input;
}
```

### 7.5 mergeDeps.js [#](#t6175-mergedepsjs)

packages\zhang-cli\lib\util\mergeDeps.js

```js
function mergeDeps(sourceDeps, depsToInject) {
  const result = Object.assign({}, sourceDeps)
  for (const depName in depsToInject) {
    result[depName] = depsToInject[depName];
  }
  return result
}

module.exports = mergeDeps;
```

### 7.6 normalizeFilePaths.js [#](#t6276-normalizefilepathsjs)

packages\zhang-cli\lib\util\normalizeFilePaths.js

```js
const slash = require('slash')
module.exports = function normalizeFilePaths (files) {
  Object.keys(files).forEach(file => {
    const normalized = slash(file)
    if (file !== normalized) {
      files[normalized] = files[file]
      delete files[file]
    }
  })
  return files
}
```

### 7.7 GeneratorAPI.js [#](#t6377-generatorapijs)

packages\zhang-cli\lib\GeneratorAPI.js

```js
const { toShortPluginId } = require('zhang-cli-shared-utils')
const mergeDeps = require('./util/mergeDeps')
const { isBinaryFileSync } = require('isbinaryfile')
const isString = val => typeof val === 'string'
const isObject = val => val && typeof val === 'object'
const path = require('path');
const fs = require('fs');
const ejs = require('ejs');
class GeneratorAPI {
    constructor(id, generator, options, rootOptions) {
        this.id = id
        this.generator = generator
        this.options = options
        this.rootOptions = rootOptions
        this.pluginsData = generator.plugins
            .filter(({ id }) => id !== `@vue/cli-service`)
            .map(({ id }) => ({ name: toShortPluginId(id) }))
    }
    hasPlugin(id) {
        return this.generator.hasPlugin(id)
    }
    extendPackage(fields) {
        const pkg = this.generator.pkg
        const toMerge = fields
        for (const key in toMerge) {
            const value = toMerge[key]
            const existing = pkg[key]
            if (isObject(value) && (key === 'dependencies' || key === 'devDependencies')) {
                pkg[key] = mergeDeps(existing || {}, value)
            } else {
                pkg[key] = value
            }
        }
    }
    _injectFileMiddleware(middleware) {
        this.generator.fileMiddlewares.push(middleware)
    }
    _resolveData(additionalData) {
        return Object.assign({
            options: this.options,
            rootOptions: this.rootOptions,
            plugins: this.pluginsData
          }, additionalData)
    }
    render(source,additionalData) {
        const baseDir = extractCallDir()
        if (isString(source)) {
            source = path.resolve(baseDir, source)
            this._injectFileMiddleware(async (files) => {
                const data = this._resolveData(additionalData)
                const globby = require('globby')
                const _files = await globby(['**/*'], { cwd: source })
                for (const rawPath of _files) {
                    const targetPath = rawPath.split('/').map(filename => {
                        if (filename.charAt(0) === '_' && filename.charAt(1) !== '_') {
                            return `.${filename.slice(1)}`
                        }
                        return filename
                    }).join('/')
                    const sourcePath = path.resolve(source, rawPath)
                    const content = renderFile(sourcePath, data)
                    files[targetPath] = content;
                }
            })
        }
    }
}
function extractCallDir() {
    const obj = {}
    Error.captureStackTrace(obj)
    const callSite = obj.stack.split('\n')[3]
    const namedStackRegExp = /\s\((.*):\d+:\d+\)$/
    let matchResult = callSite.match(namedStackRegExp)
    const fileName = matchResult[1]
    return path.dirname(fileName)
}
function renderFile(name, data) {
    if (isBinaryFileSync(name)) {
        return fs.readFileSync(name)
    }
    const template = fs.readFileSync(name, 'utf8')
    return ejs.render(template, data)
}
module.exports = GeneratorAPI
```

### 7.8 Generator.js [#](#t6478-generatorjs)

packages\zhang-cli\lib\Generator.js

```js
const { isPlugin,matchesPluginId } = require('zhang-cli-shared-utils')
const GeneratorAPI = require('./GeneratorAPI')
const normalizeFilePaths = require('./util/normalizeFilePaths')
const writeFileTree = require('./util/writeFileTree')
const ejs = require('ejs')
class Generator {
    constructor(context, { pkg = {}, plugins = [] } = {}) {
        this.context = context
        this.plugins = plugins
        this.files = {}
        this.fileMiddlewares = []
        this.pkg = pkg;
        this.allPluginIds = Object.keys(this.pkg.dependencies || {})
            .concat(Object.keys(this.pkg.devDependencies || {}))
            .filter(isPlugin)
        const cliService = plugins.find(p => p.id === '@vue/cli-service')
        this.rootOptions = cliService.options;
    }
    async generate() {
        await this.initPlugins()

        this.extractConfigFiles()

        await this.resolveFiles()
        console.log(this.files);
        this.sortPkg()
        this.files['package.json'] = JSON.stringify(this.pkg, null, 2) + '\n'

        await writeFileTree(this.context, this.files)
    }
    sortPkg() {
        console.log('ensure package.json keys has readable order');
    }
    async resolveFiles() {
        const files = this.files
        for (const middleware of this.fileMiddlewares) {
            await middleware(files, ejs.render)
        }
        normalizeFilePaths(files)
    }
    extractConfigFiles() {
        console.log('extractConfigFiles');
    }
    async initPlugins() {
        const { rootOptions } = this
        for (const plugin of this.plugins) {
            const { id, apply, options } = plugin
            const api = new GeneratorAPI(id, this, options, rootOptions)
            await apply(api, options, rootOptions)
        }
    }
    hasPlugin(_id) {
        return [
          ...this.plugins.map(p => p.id),
          ...this.allPluginIds
        ].some(id => {
          return matchesPluginId(_id, id);
        })
      }
}
module.exports = Generator;
```

## 8.å®Œæˆcreateå‘½ä»¤ [#](#t658å®Œæˆcreateå‘½ä»¤)

### 8.1 Creator.js [#](#t6681-creatorjs)

packages\zhang-cli\lib\Creator.js

```diff
const { defaults } = require('./options');
const PromptModuleAPI = require('./PromptModuleAPI');
const inquirer = require('inquirer')
const cloneDeep = require('lodash.clonedeep')
const writeFileTree = require('./util/writeFileTree')
const { chalk, execa,loadModule } = require('zhang-cli-shared-utils')
const Generator = require('./Generator')
const isManualMode = answers => answers.preset
class Creator {
    constructor(name, context, promptModules) {
        this.name = name;
        this.context = process.env.VUE_CLI_CONTEXT = context;
        const { presetPrompt, featurePrompt } = this.resolveIntroPrompts();
        this.presetPrompt = presetPrompt;
        this.featurePrompt = featurePrompt;
        this.injectedPrompts = []
        this.promptCompleteCbs = []
        this.run = this.run.bind(this)//è¿è¡Œå‡½æ•°
        const promptAPI = new PromptModuleAPI(this)
        promptModules.forEach(m => m(promptAPI))
    }
    run(command, args) {
        return execa(command, args, { cwd: this.context })
    }
    async create() {
        const {name,context,run} = this;
        let preset = await this.promptAndResolvePreset()
        console.log('preset', preset);
        preset = cloneDeep(preset);
        preset.plugins['@vue/cli-service'] = Object.assign({projectName: name}, preset);
        console.log(`âœ¨  Creating project in ${chalk.yellow(context)}.`)
        const pkg = {
            name,
            version: '0.1.0',
            private: true,
            devDependencies: {}
        }
        const deps = Object.keys(preset.plugins)
        deps.forEach(dep => {
            pkg.devDependencies[dep] = 'latest';
        })
        await writeFileTree(context, {
            'package.json': JSON.stringify(pkg, null, 2)
        })
        console.log(`ðŸ—ƒ  Initializing git repository...`)
        await run('git init');
        console.log(`âš™\u{fe0f} Installing CLI plugins. This might take a while...`)
        await run('npm install');
        console.log(`ðŸš€  Invoking generators...`)
        const plugins = await this.resolvePlugins(preset.plugins)
        const generator = new Generator(context, {pkg,plugins})
        await generator.generate();
+       console.log(`ðŸ“¦  Installing additional dependencies...`)
+       await run('npm install');
+       console.log('ðŸ“„  Generating README.md...')
+       await writeFileTree(context, {
+           'README.md': `cd ${name}\n npm run serve`
+       })
+       await run('git', ['add', '-A'])
+       await run('git', ['commit', '-m', 'created', '--no-verify'])
+       console.log(`ðŸŽ‰  Successfully created project ${chalk.yellow(name)}.`)
+       console.log(
+           `ðŸ‘‰  Get started with the following commands:\n\n` +
+           (chalk.cyan(`cd ${name}\n`)) +
+           (chalk.cyan(`npm run serve`))
+       )
+       generator.printExitLogs()
    }
    //éåŽ†æ’ä»¶çš„generator,æ’ä»¶é€šè¿‡GeneratorAPIå‘package.jsonä¸­åŠ å…¥ä¾èµ–æˆ–å­—æ®µï¼Œå¹¶é€šè¿‡renderå‡†å¤‡æ·»åŠ æ–‡ä»¶
    async resolvePlugins(rawPlugins) {
        const plugins = []
        for (const id of Object.keys(rawPlugins)) {
            try{
                const apply = loadModule(`${id}/generator`, this.context) || (() => {})
                let options = rawPlugins[id] || {}
                plugins.push({ id, apply, options })
            }catch(error){
                console.log(error);
            }
        }
        return plugins
    }
    resolveFinalPrompts() {
        this.injectedPrompts.forEach(prompt => {
            const originalWhen = prompt.when || (() => true)
            prompt.when = answers => {
                return isManualMode(answers) && originalWhen(answers)
            }
        })
        const prompts = [
            this.presetPrompt,
            this.featurePrompt,
            ...this.injectedPrompts,
        ]
        return prompts
    }
    async promptAndResolvePreset(answers = null) {
        if (!answers) {
            answers = await inquirer.prompt(this.resolveFinalPrompts())
        }
        let preset;
        if (answers.preset && answers.preset !== '__manual__') {
            preset = await this.resolvePreset(answers.preset)
        } else {
            preset = {
                plugins: {}
            }
            answers.features = answers.features || []
            this.promptCompleteCbs.forEach(cb => cb(answers, preset))
        }
        return preset
    }
    async resolvePreset (name) {
        const savedPresets = this.getPresets()
        return savedPresets[name];
    }
    getPresets() {
        return Object.assign({}, defaults.presets)
    }
    resolveIntroPrompts() {
        const presets = this.getPresets()
        const presetChoices = Object.entries(presets).map(([name]) => {
            let displayName = name
            if (name
                displayName = 'Default'
            } else if (name
                displayName = 'Default (Vue 3)'
            }
            return {
                name: `${displayName}`,
                value: name
            }
        })
        const presetPrompt = {
            name: 'preset',
            type: 'list',
            message: `Please pick a preset:`,
            choices: [
                ...presetChoices,
                {
                    name: 'Manually select features',
                    value: '__manual__'
                }
            ]
        }
        const featurePrompt = {
            name: 'features',
            when: isManualMode,
            type: 'checkbox',
            message: 'Check the features needed for your project:',
            choices: [],
            pageSize: 10
        }
        return {
            presetPrompt,
            featurePrompt
        }
    }
}

module.exports = Creator;
```

### 8.2 Generator.js [#](#t6782-generatorjs)

packages\zhang-cli\lib\Generator.js

```diff
const { isPlugin,matchesPluginId } = require('zhang-cli-shared-utils')
const GeneratorAPI = require('./GeneratorAPI')
const normalizeFilePaths = require('./util/normalizeFilePaths')
const writeFileTree = require('./util/writeFileTree')
const ejs = require('ejs')
class Generator {
    constructor(context, { pkg = {}, plugins = [] } = {}) {
        this.context = context
        this.plugins = plugins
        this.files = {}
        this.fileMiddlewares = []
        this.pkg = pkg;
        this.allPluginIds = Object.keys(this.pkg.dependencies || {})
            .concat(Object.keys(this.pkg.devDependencies || {}))
            .filter(isPlugin)
        const cliService = plugins.find(p => p.id
        this.rootOptions = cliService.options;
    }
    async generate() {
        await this.initPlugins()
        this.extractConfigFiles()
        await this.resolveFiles()
        this.sortPkg()
        this.files['package.json'] = JSON.stringify(this.pkg, null, 2) + '\n'
        await writeFileTree(this.context, this.files)
    }
    sortPkg() {
        console.log('ensure package.json keys has readable order');
    }
    async resolveFiles() {
        const files = this.files
        for (const middleware of this.fileMiddlewares) {
            await middleware(files, ejs.render)
        }
        normalizeFilePaths(files)
    }
    extractConfigFiles() {
        console.log('extractConfigFiles');
    }
    async initPlugins() {
        const { rootOptions } = this
        for (const plugin of this.plugins) {
            const { id, apply, options } = plugin
            const api = new GeneratorAPI(id, this, options, rootOptions)
            await apply(api, options, rootOptions)
        }
    }
    hasPlugin(_id) {
        return [
          ...this.plugins.map(p => p.id),
          ...this.allPluginIds
        ].some(id => {
          return matchesPluginId(_id, id);
        })
    }
+    printExitLogs(){
+        console.log('printExitLogs');
+    }
}

module.exports = Generator;
```
